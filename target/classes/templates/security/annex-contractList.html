<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
	<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport"/>
	<link rel="stylesheet" th:href="@{/static/bootstrap/css/bootstrap.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/dist/css/font-awesome.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/dist/css/ionicons.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/plugins/jvectormap/jquery-jvectormap-1.2.2.css}"/>
	<link rel="stylesheet" th:href="@{/static/dist/css/AdminLTE.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/dist/css/skins/_all-skins.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/css/common.css}"/>
	<link th:href="@{/static/plugins/bootstrap-fileinput/css/fileinput.css}" media="all" rel="stylesheet" type="text/css"/>
	<link th:href="@{/static/plugins/bootstrap-fileinput/themes/explorer-fa/theme.css}" media="all" rel="stylesheet" type="text/css"/>
</head>
<body>
	<div class="container-fluid">
		<form style="margin-top:10px;">
			<div class="form-group">
	            <div class="file-loading">
	                <input id="file-5" type="file" multiple="multiple"/>
	            </div>
	        </div>
		</form>
		<p style="font-size:12px;">说明：正文上传大小限制为100 MB，一次只允许上传一份；doc,docx类型的文件!</p>
		<button class="btn btn-block btn-primary btn-lg" style="width:30%;margin:0 auto;" onclick="fnOK()">保存并关闭</button>
	</div>
</body>
<script type="text/javascript" th:src="@{/static/plugins/jQuery/jquery-2.2.3.min.js}"></script>
<script type="text/javascript" th:src="@{/static/bootstrap/js/bootstrap.min.js}"></script>
<script type="text/javascript" th:src="@{/static/dist/js/app.min.js}"></script>
<script type="text/javascript" th:src="@{/static/js/common.js}"></script>
<!-- bootstrap fileinput js -->
<script th:src="@{/static/plugins/bootstrap-fileinput/js/plugins/sortable.min.js}" type="text/javascript"></script>
<script th:src="@{/static/plugins/bootstrap-fileinput/js/plugins/purify.min.js}" type="text/javascript"></script>
<script th:src="@{/static/plugins/bootstrap-fileinput/js/fileinput.min.js}" type="text/javascript"></script>
<script th:src="@{/static/plugins/bootstrap-fileinput/js/locales/fr.js}" type="text/javascript"></script>
<script th:src="@{/static/plugins/bootstrap-fileinput/js/locales/zh.js}" type="text/javascript"></script>
<script th:src="@{/static/plugins/bootstrap-fileinput/themes/explorer-fa/theme.js}" type="text/javascript"></script>
<script th:src="@{/static/plugins/bootstrap-fileinput/themes/fa/theme.js}" type="text/javascript"></script>

<script th:inline="javascript" type="text/javascript">
/*<![CDATA[*/
	var CTX = [[@{/}]];
	var STATIC = [[@{/static/}]];
	var Annexes = [[${annexes}]];
	var folderId = [[${folderId}]];
	var ADD_Annexes = [];
	$(function(){
		var initialPreview = [];
		var initialPreviewConfig = [];
		if(Annexes!=null&&Annexes.length>0){
			var url = window.location.host;
			$.each(Annexes,function(i,annex){
				initialPreview.push('http://'+url+STATIC+annex.relativePath);
				var type = 'image';
				if(annex.extendName=='pdf'){type = 'pdf';}
				if(annex.extendName=='doc'||annex.extendName=='docx'||annex.extendName=='xls'||annex.extendName=='xlsx'||annex.extendName=='pptx'){type = 'office';}
				initialPreviewConfig.push({type:type,caption:annex.name+'.'+annex.extendName,downloadUrl:STATIC+annex.relativePath,size:annex.fileSize,key:annex.id});
			});
		}
		$("#file-5").fileinput({
	    	language:'zh',
	    	initialPreview: initialPreview,//[url1, url2],
	        initialPreviewAsData: true,
	        initialPreviewConfig: initialPreviewConfig,
	        deleteUrl: CTX+"annex/delete-annex",
	        uploadUrl: CTX+"annex/upload-annex",
	        uploadExtraData:{folderId:folderId},
	        overwriteInitial: false,
	        showUpload:false,
	        allowedFileExtensions: ['doc','docx'],//'jpg', 'png', 'gif','jpeg','bmp','pdf','xls','xlsx'
	        maxFileSize: 100*1024,
	        maxFileCount:1,
	        enctype: 'multipart/form-data',
	        validateInitialCount: true,
	        msgFilesTooMany: "选择上传的文件数量({n}) 超过允许的最大数值{m}！"
	    }).on('filebatchselected', function (event, files) {//选中文件事件
            $(this).fileinput("upload");
        });
		
		//上传附件成功回调
		$("#file-5").on("fileuploaded", function (event, data, previewId, index){
	    	if(data.response.success){
	    		ADD_Annexes.push({annex:data.response.data,keyId:previewId});
	    	}
	    });
		
		//删除已上传附件回调
		$("#file-5").on('filesuccessremove',function(event, previewId){
			if(ADD_Annexes.length>0){
				var temp_add_annexes = [];
				for(var i=0;i<ADD_Annexes.length;i++){
					if(ADD_Annexes[i].keyId == previewId){
						fnDelAnnex(ADD_Annexes[i].annex.id);
					}else{
						temp_add_annexes.push(ADD_Annexes[i]);
					}
				}
				ADD_Annexes = temp_add_annexes;
			}
	    });
		//删除服务端附件回调
		$("#file-5").on('filedeleted', function(event, key) {
			if(Annexes!=null){
				var temp_annexes = [];
				for(var i=0;i<Annexes.length;i++){
					if(Annexes[i].id != key){
						temp_annexes.push(Annexes[i]);
					}
				}
				Annexes = temp_annexes;
			}
		});  
	});
	
	function fnDelAnnex(annexId){
		$.ajax({
			url: CTX+"annex/delete-annex",
			type: "POST",
			data: {key: annexId},
			dataType: 'json',
			success: function(data){
				if(data.success){}
			}
		});
	}
	
	function parentCallBack(){
		if(ADD_Annexes.length>0){
			$.each(ADD_Annexes,function(i,newAnnex){
				if(Annexes==null){Annexes = [];}
				Annexes.push(newAnnex.annex);
			});
		}else{
			ADD_Annexes = [];
		}
		if(Annexes==null){
			Annexes = [];
		}
		return Annexes;
	}
	function fnOK(){
		window.parent.closeUploadAnnexWin();
	}
	
/*]]>*/	
</script>
</html>

