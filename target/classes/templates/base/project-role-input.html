<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
	<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport"/>
	<title th:text="角色项目管理"></title>
	
	<link rel="stylesheet" th:href="@{/static/bootstrap/css/bootstrap.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/dist/css/font-awesome.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/dist/css/ionicons.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/plugins/jvectormap/jquery-jvectormap-1.2.2.css}"/>
	<!-- bootstrap datepicker -->
  	<link rel="stylesheet" th:href="@{/static/plugins/datepicker/datepicker3.css}"/>
  	<!-- daterange picker -->
  	<link rel="stylesheet" th:href="@{/static/plugins/daterangepicker/daterangepicker.css}"/>
	<!-- Theme style -->
	<link rel="stylesheet" th:href="@{/static/dist/css/AdminLTE.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/dist/css/skins/_all-skins.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/css/common.css}"/>
	<link rel="stylesheet" th:href="@{/static/plugins/bootstrap-toggle/bootstrap-toggle.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/plugins/bootstrap-treeview/bootstrap-treeview.min.css}"/>
		<link rel="stylesheet" th:href="@{/static/plugins/bootstrap-table/dist/bootstrap-table.min.css}"/>

</head>
<body>
	<section class="content">
		<form id="selection_project_form" class="form-horizontal">
		<input type="hidden" name="id" th:value="${roleId}"/>
		<div class="box box-default box-solid" style="margin-bottom:5px;">
            <div class="box-header with-border">
              	<h3 class="box-title">已选择项目</h3>
              	<div class="box-tools pull-right">
                	<button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
                	</button>
             	</div>
              	<!-- /.box-tools -->
            </div>
            <!-- /.box-header -->
            <div class="box-body" style="display: block;" id="selected_project">
            </div>
            <!-- /.box-body -->
        </div>
        
        <div class="box box-default box-solid" style="margin-bottom:5px;">
            <div class="box-header with-border">
              	<h3 class="box-title">待选项目</h3>
              	<div class="box-tools pull-right">
                	<button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
                	</button>
             	</div>
              	<!-- /.box-tools -->
            </div>
            <!-- /.box-header -->
            <div class="box-body" style="display: block;">
		            <!-- 左侧项目列表-->
					    <div class="col-sm-2" style="background-color: #d2d6de;">
					        <div class="row">
					          <div class="box-header with-border" >
					              <h3 class="box-title" id="projectName"><i class="fa fa-align-left"></i>&nbsp;&nbsp;项目目录</h3>
					         </div>
					        </div>
					        <!-- 项目列表-->
					         <div class="row">
					             <div id="MenuTree" data-toggle="context" data-target="#context-menu"></div>
					         </div>
					    </div>
					  <!-- 右侧信息-->
					  <div class="col-sm-10">
				              <input type="hidden" id="projectGroupId" name="projectGroup.id" />
							  <table id="dataList"></table>
			           </div>
            </div>
        </div>
        
        </form>
        <div class="row" style="margin-top:20px;">
        	<div class="col-md-6">
	        	<button type="button" class="btn btn-block btn-default" onclick="fnCloseWin()" style="width:80px;float:right;">关闭</button>
	        </div>
	        <div class="col-md-6">
	        	<button type="button" class="btn btn-block btn-primary" onclick="fnSaveEditForm()" style="width:80px;">保存</button>
	        </div>
        </div>
	</section>
	
</body>
<script type="text/javascript" th:src="@{/static/plugins/jQuery/jquery-2.2.3.min.js}"></script>
<script type="text/javascript" th:src="@{/static/bootstrap/js/bootstrap.min.js}"></script>
<script th:src="@{/static/plugins/bootstrap-table/dist/bootstrap-table.min.js}"></script>
<script th:src="@{/static/plugins/bootstrap-table/dist/locale/bootstrap-table-zh-CN.min.js}"></script>
<script th:src="@{/static/plugins/bootstrap-table/dist/extensions/export/bootstrap-table-export.min.js}"></script>
<!-- Slimscroll -->
<script type="text/javascript" th:src="@{/static/plugins/slimScroll/jquery.slimscroll.min.js}"></script>
<!-- bootstrap datepicker -->
<script type="text/javascript" th:src="@{/static/plugins/datepicker/bootstrap-datepicker.js}"></script>
<script type="text/javascript" th:src="@{/static/plugins/datepicker/locales/bootstrap-datepicker.zh-CN.js}"></script>
<script type="text/javascript" th:src="@{/static/dist/js/app.min.js}"></script>
<script type="text/javascript" th:src="@{/static/js/common.js}"></script>
<script type="text/javascript" th:src="@{/static/plugins/bootstrap-validator/js/bootstrapValidator.min.js}"></script>
<script type="text/javascript" th:src="@{/static/plugins/bootstrap-treeview/bootstrap-treeview.min.js}"></script>
<script type="text/javascript" th:src="@{/static/plugins/bootstrap-contextmenu/bootstrap-contextmenu.js}"></script>
<script type="text/javascript" th:src="@{/static/plugins/bootstrap-contextmenu/prettify.js}"></script>
<script th:inline="javascript" type="text/javascript">
/*<![CDATA[*/
	var CTX = [[@{/}]];
	var STATIC = [[@{/static/}]];
	$(function(){
		//Date picker
	    $('.datepicker').datepicker({
	    	format:'yyyy-mm-dd',
	    	language:'zh-CN',
	      	autoclose: true
	    }).on('hide',function(){
			if($(this).val()!=''){
				var bootstrapValidator = $("#selection_project_form").data('bootstrapValidator');  
			    bootstrapValidator.updateStatus($(this).attr('name'), 'NOT_VALIDATED').validateField($(this).attr('name'));
			}
		});
		
	    /* 左侧树、右侧表格在弹出模态框时触发 */
    	initMenuTree();//初始化项目列表树
    	$("#dataList").bootstrapTable('destroy');//销毁之前的表格，才会再次请求数据库
    	//1.初始化Table
	    var oTable = new TableInit();
	    oTable.Init();
	    
	    var roleId= $('#selection_project_form').find("input[name='id']").val();//设备Id
	    var r = Math.random().toString().substring(5);
		 $.ajax({
             type: "GET",
             url: CTX+'project-role/get-role-project?Mathnum=' + r,
             data: {roleId:roleId},
             dataType: "json",
             success: function(data){
            	 /* 处理如果该角色已经有项目了，就显示在已选区域 */
            	 $.each(data.projectInfos,function(i,projectInfo){
            		 appendProject(projectInfo.projectInfoId,projectInfo.projectInfoName);
            	 });
            	 getAllProjectsToCheck();
             },
             error: function(XMLHttpRequest, textStatus, errorThrown) {
                 alert(XMLHttpRequest.status);
                 alert(XMLHttpRequest.readyState);
                 alert(textStatus);
               }
         });
	});
	    
	
	function fnCloseWin(){
		window.parent.closeCommonFrameWin();
	}
	
	/* 初始化列表 */
	var TableInit = function () {
	    var oTableInit = new Object();
	    //初始化Table
	    oTableInit.Init = function () {
	        $('#dataList').bootstrapTable({
	        	url: CTX + 'project-role/query-project-info-page',         //请求后台的URL（*）
	            method: 'get',                      //请求方式（*）
	            toolbar: '#toolbar',                //工具按钮用哪个容器
	            //toolbarAlign:'left',				//工具栏位置
	            striped: true,                      //是否显示行间隔色
	            cache: false,                       //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
	            pagination: true,                   //是否显示分页（*）
	            sortable: false,                     //是否启用排序
	            sortOrder: "asc",                   //排序方式
	            queryParams: oTableInit.queryParams,//传递参数（*）
	            sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
	            pageNumber:1,                       //初始化加载第一页，默认第一页
	            pageSize: 10,                       //每页的记录行数（*）
	            pageList: [10, 25, 50, 100],        //可供选择的每页的行数（*）
	            queryParamsType: "a",
	            search: false,                       //是否显示表格搜索
	            strictSearch: false,
	            showColumns: false,                  //是否显示所有的列
	            showRefresh: false,                  //是否显示刷新按钮
	            minimumCountColumns: 2,             //最少允许的列数
	            clickToSelect: true,                //是否启用点击选中行
	            height:$(window).height()-80,	    //行高，如果没有设置height属性，表格自动根据记录条数觉得表格高度
	            uniqueId: "id",                     //每一行的唯一标识，一般为主键列
	            showToggle:false,                    //是否显示详细视图和列表视图的切换按钮
	            cardView: false,                    //是否显示详细视图
	            detailView: false,                  //是否显示父子表
	            showExport: false,                     //是否显示导出
	            exportDataType: "basic",              //basic', 'all', 'selected'.
	            exportTypes:[ 'excel','doc', 'xml','csv','json'],  //导出文件类型
	            exportOptions:{  
	                ignoreColumn: [0],  //忽略某一列的索引 ,如 [0,1]
	                fileName: '参建单位导出',  //文件名称设置  
	                worksheetName: '信息',  //表格工作区名称  
	                tableName: '参建单位导出文件'
	            },
	         	// 1.点击每行进行函数的触发
				onClickRow : function(row, tr,flied){
			    },
	    		//2. 点击前面的复选框进行对应的操作
	    		//点击 全选框 时触发的操作
	            onCheckAll:function(rows){
	    		  for(var i =0;i<rows.length;i++){
	    			    var id = rows[i].id;
	    	   			var name = rows[i].projectName;
	    	   			 appendProject(id,name);
	    			}
	            },
	          //点击 全选框-反选 时触发的操作
	           onUncheckAll:function(rows){
		        var Ids = [];
		    	for(var i =0;i<rows.length;i++){
		    			   var id = rows[i].id;
		    			   Ids.push(id);
		    		}
		    		  removeAllProjectre(Ids);
		            },
	    		//点击每一个单选框时触发的操作
	            onCheck:function(row){
	            var id=row.id;
	      		var name=row.projectName;
	            appendProject(id,name);
	            },
	   		 	//取消每一个单选框时对应的操作；
	           onUncheck:function(row){
	              var id=row.id;
	              removeProjects(id);
	            }, 
	            columns: [
				{
	            	checkbox:true,
	            	selectItemName:'mycheckboxs',
		        },{
				    field: 'projectLicence',
				    title:'施工许可证',
				    align : 'center',
				    sortable:true
				},{
				    field: 'projectName',
				    title:'工程名称',
				    align : 'center',
				    sortable:true
				},{
				    field: 'conAmount',
				    title:'合同金额',
				    align : 'center',
				    sortable:true,
					formatter:function (value) {
                        return value + '万元';
                    }
				},{
				    field: 'startDate',
				    title:'开工日期',
				    align : 'center',
				    sortable:true,
                    formatter:function (value) {
                        if(value == null || value == ''){return null;}
                        return new Date(value).Format('yyyy-MM-dd');
                    }
				},{
				    field: 'planEndDate',
				    title:'计划竣工日期',
				    align : 'center',
				    sortable:true,
                    formatter:function (value) {
                        if(value == null || value == ''){return null;}
                        return new Date(value).Format('yyyy-MM-dd');
                    }
				},{
				    field: 'projectNature',
				    title:'项目性质',
				    align : 'center',
				    sortable:true
				},{
				    field: 'projectStatus',
				    title:'项目状态',
				    align : 'center',
				    sortable:true,
				    formatter:function(value){
                        if(value == 0){
                            return '开工';
                        }else if(value == 1){
                            return '停工';
                        }else if(value==2)
                            return '复工';
                        else if(value==3)
                            return '结束';
                        else
                            return null;
				    }
				},]
	        });
	        $('.search input').attr('placeholder','工程名称');
	    };

	    //得到查询的参数
	    oTableInit.queryParams = function (params) {
	        var temp = {   //这里的键的名字和控制器的变量名必须一致，这边改动，控制器也需要改成一样的
	    		pageNum: params.pageNumber,//页码params.offset
                size: params.pageSize,//页面大小params.limit
                order: params.sortOrder,//排序 params.order
                ordername: params.sortName,//排序字段 params.sort
                search:params.searchText,
                contentprojectGroupId:$("#projectGroupId").val()
	        };
	        return temp;
	    };
	    return oTableInit;
	};
	
		/* 表格加载完成事件 */
		$(function(){
	        /*加载事件*/
	        $("#dataList").on('load-success.bs.table', function (e, data) {
	        	 //初始化CheckBox
	         	getAllProjectsToCheck();
	        });
		});
	
	    //初始化项目列表树
	    function initMenuTree() {
	    	var r = Math.random().toString().substring(5);
	        $.ajax({
	            url: CTX + 'project-info-area/query-ProjectArea-tree?Mathnum=' + r,
	            method: 'GET',
	            dataType: 'json',
	            success: function (json) {
	                $('#MenuTree').treeview({
	                    showTags: true,
	                    levels:1,//展示一个节点
	                    data: json,
	                    onNodeSelected: function(event, node) {
	                        clickAreaTree(event, node);
	                    }
	                });
	            },
	            error: function () {
	                loaded();
	                alert('请求超时或系统出错');
	            }
	        });
	    }
	    
	    
	  //项目组选中事件
	    function clickAreaTree(event, node) {
	        $("#projectGroupId").val(node.id);
	        $("#dataList").bootstrapTable('refresh');
	    }

	// 全选
	function swapCheck() {  
			$("input[type='checkbox']").prop('checked',true);
			$("input[type='checkbox']").each(function(){
				var id = $(this).val();
				var name = $(this).attr('field');
				 appendProject(id,name);
			});
	} 
	 
	//判断单选和取消
	function change(selecte){  
		var id=selecte.value;
		var name=$('.name'+id).attr('field');
		if($(selecte).is(':checked')){
			 appendProject(id,name);
		}else{
			    removeProject(id);
		}
	} 
	
	var appendProject = function(id,name){
	var htmlStr = '';	
	if(id!=null&&name!=null){
	htmlStr +=  
		'<div id="selected_project'+id+'" class="allProject" style="background-color:#3daae8;color:white;width:auto;hight:60px;float:left;margin:5px;">'+
	    '	<input type="hidden" name="project_id" class="personnelId" value="'+id+'"/>'+
	    '<spand style="padding-left: 5px;padding-right: 5px;">'+name+'</spand>'+
	    '	<input type="button" class="closeDiv" onclick="removeProject(\''+id+'\')" value="X" style="background:transparent;border:none;"/>'+
	    '</div>';
	    /* 如果项目已经存在，则不加入 */
	   if(getAllProjects(id)!=false){
		  $('#selected_project').append(htmlStr);
		 } 
	}
	}
	
	/* 单个移除 */
	var removeProject = function(id){
		$('#selected_project'+id).remove();//移出已选区域
		//修改表格的复选框状态
	    var index = -1;
		$('#dataList tr').each(function(){
			if($(this).attr('data-uniqueid')==id){
				index=$(this).attr('data-index');
			}
		});
	    if(index!=-1){
	    	$('#dataList').bootstrapTable('uncheck',index);
	    }
		//删除操作
	 	 var Ids=[id];
	}
	/* 点击行移除 */
	var removeProjects = function(id){
		// 得到页面中所有input
		var allInputs = document.getElementsByTagName('input');
		var Ids = [];
		// 在所有Input中过滤出type="hidden" and name="project_id"的元素，放到数组libIds中
		for (var i =0; i < allInputs.length; i++) {
			if (allInputs[i].type === 'hidden' && allInputs[i].name === 'project_id') {
				Ids.push(allInputs[i].value);
			}
		}
		var flag=false;
		for(var i = 0; i < Ids.length; i++){
	        if(id === Ids[i]){
	          flag=true;
	        }
	    }
		if(flag==true){
		//移出已选区域
		$('#selected_project'+id).remove();
		//修改表格的复选框状态
	    var index = -1;
		$('#dataList tr').each(function(){
			if($(this).attr('data-uniqueid')==id){
				index=$(this).attr('data-index');
			}
		});
	    if(index!=-1){
	    	$('#dataList').bootstrapTable('uncheck',index);
	    }
		//删除操作
	 	 var Ids=[id];
		}
	}
	
	/*全部移除*/
	 var removeAllProjectre = function(Ids){
	      $('.allProject').remove();
	      $("input[type='checkbox']").prop('checked',false);
	}
	
	 /* 获取项目 判断是否存在*/
	 function getAllProjects(id) {
		// 得到页面中所有input
		var allInputs = document.getElementsByTagName('input');
		var Ids = [];
		// 在所有Input中过滤出type="hidden" and name="project_id"的元素，放到数组libIds中
		for (var i =0; i < allInputs.length; i++) {
			if (allInputs[i].type === 'hidden' && allInputs[i].name === 'project_id') {
				Ids.push(allInputs[i].value);
			}
		}
		/* 判断是否已存在项目 已存在就返回false */
		for(var j=0;j<Ids.length;j++){
		if(id === Ids[j]){
            return false;
        	}
		}
		for(var j=0;j<Ids.length;j++){
			 //修改表格的选中状态
	        var index = -1;
	     	$('#dataList tr').each(function(){
	     		if($(this).attr('data-uniqueid')==Ids[j]){
	     			index = $(this).attr('data-index');
	     		}
	     	});
	     	if(index!=-1){
	     		$('#dataList').bootstrapTable('check',index);//根据下标index，修改选中状态
	     	}
		}
	 }
	 
	 /* 获取项目 CheckBox*/
	 function getAllProjectsToCheck() {
		// 得到页面中所有input
		var allInputs = document.getElementsByTagName('input');
		var Ids = [];
		// 在所有Input中过滤出type="hidden" and name="project_id"的元素，放到数组libIds中
		for (var i =0; i < allInputs.length; i++) {
			if (allInputs[i].type === 'hidden' && allInputs[i].name === 'project_id') {
				Ids.push(allInputs[i].value);
			}
		}
		for(var j=0;j<Ids.length;j++){
			 //修改表格的选中状态
	        var index = -1;
	     	$('#dataList tr').each(function(){
	     		if($(this).attr('data-uniqueid')==Ids[j]){
	     			index = $(this).attr('data-index');
	     		}
	     	});
	     	if(index!=-1){
	     		$('#dataList').bootstrapTable('check',index);//根据下标index，修改选中状态
	     	}
		}
	 }
	 
	 /* 获取已选中项目 */
	 function getProjects() {
	 		// 得到页面中所有input
	 		var allInputs = document.getElementsByTagName('input');
	 		var Ids = [' '];
	 		// 在所有Input中过滤出type="hidden" and name="project_id"的元素，放到数组libIds中
	 		for (var i = 0; i < allInputs.length; i++) {
	 			if (allInputs[i].type === 'hidden' && allInputs[i].name === 'project_id') {
	 				Ids.push(allInputs[i].value);
	 			}
	 		}
				return Ids;
	  }
	 
	 /* 保存角色项目 */
	 function fnSaveEditForm() {
		 var ids= getProjects();//获取所有项目id
		 var roleId= $('#selection_project_form').find("input[name='id']").val();
			 $.ajax({
					url: CTX+'project-role/save-role-project',
					type: 'post',
					dataType: 'json',
					data: {"ids":ids,"roleId":roleId},
					//timeout: 10000,
					success: function(json){
						if(json.success){
							alert(json.msg);
							window.parent.closeCommonFrameWin();
						}else{
							alert(json.msg);
						}
		            },  
					error: function(){
						alert('请求超时或系统出错!');
					}
				});
	 }
	

/*]]>*/		
</script>
</html>
