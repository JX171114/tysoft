<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<!--
* @Copyright(c): 厦门路桥信息股份有限公司  版权所有
* @author :Administrator
* @Description:考勤信息表管理 
* @createDate:2018-3-22
-->
<head>
	<meta charset="UTF-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
	<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport"/>
	<title>考勤信息表管理</title>
	<link rel="stylesheet" th:href="@{/static/bootstrap/css/bootstrap.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/dist/css/font-awesome.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/dist/css/ionicons.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/plugins/jvectormap/jquery-jvectormap-1.2.2.css}"/>
  	<!-- daterange picker -->
  	<link rel="stylesheet" th:href="@{/static/plugins/daterangepicker/daterangepicker.css}"/>
	<!-- Theme style -->
	<link rel="stylesheet" th:href="@{/static/css/common.css}"/>
	<link rel="stylesheet" th:href="@{/static/plugins/bootstrap-toggle/bootstrap-toggle.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/plugins/bootstrap-table/dist/bootstrap-table.min.css}"/>
	<!-- iCheck for checkboxes and radio inputs -->
  	<link rel="stylesheet" th:href="@{/static/plugins/iCheck/all.css}"/>
  	<!-- datetime picker -->
  	<link rel="stylesheet" th:href="@{/static/plugins/datetimepicker/css/bootstrap-datetimepicker.min.css}"/>
  	<!-- Select2 -->
  	<link rel="stylesheet" th:href="@{/static/plugins/select2/select2.min.css}"/>
  	<link rel="stylesheet" th:href="@{/static/dist/css/AdminLTE.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/dist/css/skins/_all-skins.min.css}"/>
	<style type="text/css">
		.form-horizontal .control-label{text-align: left;}
		.table>tbody+tbody {
		    border-top: 0;
		}
		.radio{float:left;}
		.form_img img{max-width:300px;}
		.light-btn {color: #fff !important;}
		.btn-box-tool{font-size:14px;}
	</style>
</head>
<body>
    <section class="content">
    	<div class="box box-default collapsed-box box-solid" style="margin-bottom:5px;">
            <div class="box-header with-border">
              	<h3 class="box-title">查询条件</h3>
              	<div class="box-tools pull-right">
                	<button type="button" class="btn btn-box-tool" data-widget="collapse" onclick="fnResetTable()"><i class="fa fa-plus"></i></button>
             	</div>
              	<!-- /.box-tools -->
            </div>
            <!-- /.box-header -->
            <div class="box-body">
            	<form id="formSearch" class="form-horizontal">
            	<input type="hidden" name="query_projectInfo.id_eq" th:value="${projectInfo}!=null?${projectInfo.id}:''"/>
            	<div class="row">
            		<div class="col-md-3">
            			<div class="form-group" style="margin-top:1px">
	                        <label class="control-label col-sm-5">单位名称:</label>
	                        <div class="col-sm-7" style="padding:0;"> <input type="text" class="form-control" id="query_personnel.companyName_like" name="query_personnel.companyName_like" /> </div>
	                     </div>
            		</div>
            		<div class="col-md-3">
            			<label class="control-label col-sm-5">人员姓名:</label>
                        <div class="col-sm-7" style="padding:0;"> <input type="text" class="form-control" id="query_userName_like" name="query_userName_like" /> </div>
            		</div>
            		<div class="col-md-4">
            			<label class="control-label col-sm-4">身份证号:</label>
                        <div class="col-sm-8" style="padding:0;"> <input type="text" class="form-control" id="query_userIdNum_like" name="query_userIdNum_like" /> </div>
            		</div>
            		<div class="col-md-2">
            			<button type="button" onclick="queryInfo()"  id="btn_query" class="btn btn-primary">查询</button>
            		</div>
            	</div>
                </form>
            </div>
        </div>
        <div id="toolbar" class="btn-group" >
            <button id="btn_add" type="button" class="btn btn-primary">
                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>新增
            </button>
            <button id="btn_delete" type="button" class="btn btn-danger">
                <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>删除
            </button>
            <button id="btn_export" type="button" class="btn btn-success">
                <span class="glyphicon glyphicon-export" aria-hidden="true"></span>导出Excel
            </button>
            <div class="btn-group">
                <button type="button" class="btn btn-success dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                  	<span class="glyphicon glyphicon-import" aria-hidden="true"></span>导入考勤记录 <span class="caret"></span>
                </button>
                <ul class="dropdown-menu">
                  	<li><a href="javascript:">导入管理人员</a></li>
                  	<li><a href="javascript:">导入务工人员</a></li>
                </ul>
            </div>
        </div>
        <table id="dataList"></table>
    </section>
    
    <div class="modal fade" id="addModal" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static" aria-hidden="true">
		<div class="modal-dialog" style="width:800px;">
			<div class="modal-content">
				<div class="modal-header">
				 	<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
					<h4 class="modal-title">考勤信息表管理</h4>
				</div>
				<div class="modal-body" style="overflow: hidden; padding: 10px;">
					<form class="form-horizontal" id="inputForm">
            			<input type="hidden" name="id" value=""/>
            			<input type="hidden" name="projectInfo.id" th:value="${projectInfo}!=null?${projectInfo.id}:''"/>
            			<input type="hidden" name="annexIds"/>
            			<input type="hidden" name="dataFrom" value="manual"/>
						<div class="box box-default box-solid" style="margin-bottom:5px;">
				            <div class="box-header with-border">
				              	<h3 class="box-title">项目信息</h3>
				              	<div class="box-tools pull-right">
				                	<button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
				             	</div>
				              	<!-- /.box-tools -->
				            </div>
				            <!-- /.box-header -->
				            <div class="box-body">
				            	<div class="row">
				            		<div class="col-md-6">
				            			<div class="form-group">
					                        <label class="control-label col-sm-3" style="padding-right:0">项目名称:</label>
					                        <div class="col-sm-9"> <input type="text" class="form-control" readonly="readonly" th:value="${projectInfo}!=null?${projectInfo.projectName}:''"/> </div>
					                     </div>
				            		</div>
				            		<div class="col-md-6">
				            			<div class="form-group">
					            			<label class="control-label col-sm-3" style="padding-right:0">施工许可证:</label>
					                        <div class="col-sm-9"> <input type="text" class="form-control" readonly="readonly" th:value="${projectInfo}!=null?${projectInfo.projectLicence}:''"/> </div>
				            			</div>
				            		</div>
				            	</div>
				            </div>
				        </div>
				        <div class="box box-default box-solid" style="margin-bottom:5px;">
				            <div class="box-header with-border">
				              	<h3 class="box-title">考勤信息</h3>
				              	<div class="box-tools pull-right">
				                	<button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
				             	</div>
				              	<!-- /.box-tools -->
				            </div>
				            <!-- /.box-header -->
				            <div class="box-body">
				            	<div class="row">
				            		<div class="col-md-6">
				            			<div class="form-group">
					                        <label class="control-label col-sm-3" style="padding-right:5px;"><i style="color:red;">*</i>&nbsp;姓名:</label>
					                        <div class="col-sm-9">
					                        	<select class="form-control select2" style="width:100%;"></select>
					                        	<input type="hidden" name="personnel.id"/>
					                        	<input type="hidden" name="userName"/>
					                       	</div>
					                     </div>
				            		</div>
				            		<div class="col-md-6">
				            			<div class="form-group">
					            			<label class="control-label col-sm-3" style="padding-right:5px;"><i style="color:red;">*</i>&nbsp;身份证号:</label>
					                        <div class="col-sm-9"> <input type="text" class="form-control" name="userIdNum" readonly="readonly"/> </div>
				            			</div>
				            		</div>
				            		<div class="col-md-6">
				            			<div class="form-group">
					            			<label class="control-label col-sm-5" style="padding-right:5px;"><i style="color:red;">*</i>&nbsp;是否有考勤照片:</label>
				                        	<div class="col-sm-7">
					                        	<div class="radio" >
								                    <label><input type="radio" name="hasPic" class="minimal" value="true" checked="checked"/> 是</label>
							                  	</div>
							                  	<div class="radio">
								                    <label><input type="radio" name="hasPic" class="minimal" value="false"/> 否</label>
							                  	</div>
					                        </div>
					                    </div>
				            		</div>
				            		<div class="col-md-6">
				            			<div class="form-group">
					            			<label class="control-label col-sm-3" style="padding-right:5px;"><i style="color:red;">*</i>&nbsp;刷卡状态:</label>
					                        <div class="col-sm-9">
					                        	<select class="form-control" name="swipeStatus">
					                        		<option value="1">进入工地</option>
					                        		<option value="2">离开工地</option>
					                        	</select>
					                        </div>
					                    </div>
				            		</div>
				            		<div class="col-md-6">
				            			<div class="form-group">
					            			<label class="control-label col-sm-3" style="padding-right:5px;"><i style="color:red;">*</i>&nbsp;刷卡时间:</label>
					                        <div class="col-sm-9">
					                        	<div class="input-group">
								                  	<div class="input-group-addon">
								                    	<i class="fa fa-calendar"></i>
								                  	</div>
								                  	<input type="text" class="form-control mydatetimepicker" readonly="readonly" name="swipeTime"/>
								                </div>
					                        </div>
					                    </div>
				            		</div>
				            		<div class="col-md-6">
				            			<div class="form-group">
					            			<label class="control-label col-sm-3" style="padding-right:5px;"><i style="color:red;">*</i>&nbsp;人员类型:</label>
					                        <div class="col-sm-9" >
					                        	<select class="form-control" name="userType">
					                        		<option value="01">管理人员</option>
					                        		<option value="02">务工人员</option>
					                        	</select>
					                        </div>
					                    </div>
				            		</div>
				            	</div>
				            </div>
				        </div>
					
		            	<div class="box box-default box-solid" style="margin-bottom:5px;">
				            <div class="box-header with-border">
				              	<h3 class="box-title">材料管理</h3>
				              	<div class="box-tools pull-right">
				                	<button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
				                	</button>
				             	</div>
				              	<!-- /.box-tools -->
				            </div>
				            <!-- /.box-header -->
				            <div class="box-body" style="display: block;">
				            	<table class="table table-bordered">
					                <tr>
					                  <th style="width: 10px">序</th>
					                  <th>电子件名称</th>
					                  <th>电子件列表(点击查看)</th>
					                  <th>说明</th>
					                  <th width="100">管理</th>
					                </tr>
					                <tbody>
						                <tr th:each="folder:${annexFolders}">
						                  <td th:text="${folderStat.count}"></td>
						                  <td th:text="${folder.folderName}"></td>
						                  <td name="atte_infomation_annexes_td">无</td>
						                  <td th:text="${folder.remark}"></td>
						                  <td><a href="javascript:" th:onclick="'fnEditAnnex(this,'+${folder.id}+',\''+${folder.folderName}+'\')'">扫描件管理</a></td>
						                </tr>
					                </tbody>
				              	</table>
				            </div>
				        </div>
	            	</form>
				</div>
				<div class="modal-footer">
					 <button type="button" class="btn btn-primary" onclick="doSave(true)">添加并继续</button> 
					 <button type="button" class="btn btn-primary" onclick="doSave(false)">保存</button>
				</div>
			</div>
		</div>
	</div>
	
	<div class="modal fade" id="viewModal" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static" aria-hidden="true">
		<div class="modal-dialog" style="width:800px;">
			<div class="modal-content">
				<div class="modal-header">
				 	<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
					<h4 class="modal-title">考勤信息详情</h4>
				</div>
				<div class="modal-body" style="overflow: hidden; padding: 10px;">
					<form class="form-horizontal" id="viewForm">
						<div class="box box-default box-solid" style="margin-bottom:5px;">
				            <div class="box-header with-border">
				              	<h3 class="box-title">项目信息</h3>
				              	<div class="box-tools pull-right">
				                	<button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
				             	</div>
				              	<!-- /.box-tools -->
				            </div>
				            <!-- /.box-header -->
				            <div class="box-body">
				            	<div class="row">
				            		<div class="col-md-6">
				            			<div class="form-group">
					                        <label class="control-label col-sm-3" style="padding-right:0">项目名称:</label>
					                        <div class="col-sm-9"><h5 th:text="${projectInfo}!=null?${projectInfo.projectName}:''"></h5></div>
					                     </div>
				            		</div>
				            		<div class="col-md-6">
				            			<div class="form-group">
					            			<label class="control-label col-sm-3" style="padding-right:0">施工许可证:</label>
					                        <div class="col-sm-9"><h5 th:text="${projectInfo}!=null?${projectInfo.projectLicence}:''"></h5></div>
				            			</div>
				            		</div>
				            	</div>
				            </div>
				        </div>
				        <div class="box box-default box-solid" style="margin-bottom:5px;">
				            <div class="box-header with-border">
				              	<h3 class="box-title">考勤信息</h3>
				              	<div class="box-tools pull-right">
				                	<button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
				             	</div>
				              	<!-- /.box-tools -->
				            </div>
				            <!-- /.box-header -->
				            <div class="box-body">
				            	<div class="row">
				            		<div class="col-md-6">
				            			<div class="form-group">
					                        <label class="control-label col-sm-3" style="padding-right:5px;"><i style="color:red;">*</i>&nbsp;姓名:</label>
					                        <div class="col-sm-9">
					                        	<h5 class="form_val" id="user_name"></h5>
					                       	</div>
					                     </div>
				            		</div>
				            		<div class="col-md-6">
				            			<div class="form-group">
					            			<label class="control-label col-sm-3" style="padding-right:5px;"><i style="color:red;">*</i>&nbsp;身份证号:</label>
					                        <div class="col-sm-9">
					                        	<h5 class="form_val" id="user_id_num"></h5>
					                        </div>
				            			</div>
				            		</div>
				            		<div class="col-md-6">
				            			<div class="form-group">
					            			<label class="control-label col-sm-5" style="padding-right:5px;">是否有考勤照片:</label>
				                        	<div class="col-sm-7">
					                        	<h5 class="form_val" id="has_pic"></h5>
					                        </div>
					                    </div>
				            		</div>
				            		<div class="col-md-6">
				            			<div class="form-group">
					            			<label class="control-label col-sm-3" style="padding-right:5px;">刷卡状态:</label>
					                        <div class="col-sm-9">
					                        	<h5 class="form_val" id="swipe_status"></h5>
					                        </div>
					                    </div>
				            		</div>
				            		<div class="col-md-6">
				            			<div class="form-group">
					            			<label class="control-label col-sm-3" style="padding-right:5px;">刷卡时间:</label>
					                        <div class="col-sm-9">
					                        	<h5 class="form_val" id="swipe_time"></h5>
					                        </div>
					                    </div>
				            		</div>
				            		<div class="col-md-6">
				            			<div class="form-group">
					            			<label class="control-label col-sm-3" style="padding-right:5px;"><i style="color:red;">*</i>&nbsp;人员类型:</label>
					                        <div class="col-sm-9" >
					                        	<h5 class="form_val" id="user_type"></h5>
					                        </div>
					                    </div>
				            		</div>
				            	</div>
				            </div>
				        </div>
					
		            	<div class="box box-default box-solid" style="margin-bottom:5px;">
				            <div class="box-header with-border">
				              	<h3 class="box-title">考勤照片</h3>
				              	<div class="box-tools pull-right">
				                	<button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
				                	</button>
				             	</div>
				              	<!-- /.box-tools -->
				            </div>
				            <!-- /.box-header -->
				            <div class="box-body" style="display: block;">
				            	<div class="form_img" style="margin:0 auto;text-align:center;">
				            		<img th:src="@{/static/images/no_man.png}"/>
				            	</div>
				            </div>
				        </div>
	            	</form>
				</div>
			</div>
		</div>
	</div>
</body>
<!-- jQuery 2.2.3 -->
<script th:src="@{/static/plugins/jQuery/jquery-2.2.3.min.js}"></script>
<!-- Bootstrap 3.3.7 -->
<script th:src="@{/static/bootstrap/js/bootstrap.min.js}"></script>
<script type="text/javascript" th:src="@{/static/dist/js/app.min.js}"></script>
<script th:src="@{/static/js/common.js}"></script>
<script th:src="@{/static/plugins/bootstrap-validator/js/bootstrapValidator.min.js}"></script>
<script th:src="@{/static/plugins/bootstrap-table/dist/bootstrap-table.min.js}"></script>
<script th:src="@{/static/plugins/bootstrap-table/dist/locale/bootstrap-table-zh-CN.min.js}"></script>
<script th:src="@{/static/plugins/jQuery/jquery.serializejson.min.js}"></script>
<!-- Slimscroll -->
<script type="text/javascript" th:src="@{/static/plugins/slimScroll/jquery.slimscroll.min.js}"></script>
<!-- iCheck 1.0.1 -->
<script type="text/javascript" th:src="@{/static/plugins/iCheck/icheck.min.js}"></script>
<!-- datetime picker -->
<script type="text/javascript" th:src="@{/static/plugins/datetimepicker/js/bootstrap-datetimepicker.min.js}"></script>
<script type="text/javascript" th:src="@{/static/plugins/datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js}"></script>
<!-- Select2 -->
<script type="text/javascript" th:src="@{/static/plugins/select2/select2.full.min.js}"></script>
<script type="text/javascript" th:src="@{/static/plugins/select2/i18n/zh-CN.js}"></script>
<script th:inline="javascript" type="text/javascript">
/*<![CDATA[*/
	var CTX = [[@{/}]];
	var STATIC = [[@{/static/}]];
	
	$(window).resize(function(){
		$('#dataList').bootstrapTable('refreshOptions',{
			height:$(window).height()-80
		});
		$('.search input').attr('placeholder','人员姓名');
	});
	
	function fnResetTable(){
		window.setTimeout(function(){
			$('#dataList').bootstrapTable('resetView');
		},500);
	}
	$(function () {
	    var oTable = new TableInit();
	    oTable.Init();
	    
		$('input[type="radio"].minimal').iCheck({
	      	checkboxClass: 'icheckbox_minimal-blue',
	      	radioClass: 'iradio_minimal-blue'
	    });
		
		$('.mydatetimepicker').datetimepicker({
	    	format:'yyyy-mm-dd hh:ii:ss',
	    	todayHighlight: true,
	    	language:'zh-CN',
	      	autoclose: true
	    }).on('hide',function(){
			if($(this).val()!=''){
				var bootstrapValidator = $("#inputForm").data('bootstrapValidator');  
			    bootstrapValidator.updateStatus($(this).attr('name'), 'NOT_VALIDATED').validateField($(this).attr('name'));
			}
		});
		
		//初始化验证表单
		$('#inputForm').bootstrapValidator({
			message: '此处输入有误',
	        excluded: [':disabled'],
	        feedbackIcons: {
	            valid: 'glyphicon glyphicon-ok',
	            invalid: 'glyphicon glyphicon-remove',
	            validating: 'glyphicon glyphicon-refresh'
	        },
	        fields:{
	        	'userName':{
	        		message: '用户姓名输入不合法',
	                validators: {
	                    notEmpty: {
	                        message: '用户姓名不可为空'
	                    }
	                }
	        	},
	        	'userIdNum':{
	        		message: '身份证输入不合法',
	                validators: {
	                    notEmpty: {
	                        message: '身份证不可为空'
	                    }
	                }
	        	},
	        	'swipeTime':{
	        		message: '刷卡时间输入不合法',
	                validators: {
	                    notEmpty: {
	                        message: '刷卡时间不可为空'
	                    }
	                }
	        	}
	        }
		});
		
		$('#addModal').on('hidden.bs.modal',function(){
			resetForm();
		});
		$('#viewModal').on('hidden.bs.modal',function(){
			$('.form_val').empty();
			$('.form_img').html('<img src="'+STATIC+'images/no_man.png"/>');
		});
		
		//初始化人员选择下拉框
		$('.select2').select2({
			language: "zh-CN", //设置 提示语言
            placeholder: "请选择",
            allowClear: true,
			ajax: {
                url: CTX+"atte-infomation/query-personnel",
                dataType: 'json',
                delay: 500,
                data: function (params) {
                    return {
                    	projectInfoId:$("input[name='projectInfo.id']").val(),
                        search: params.term, // 搜索文字
                        page: params.page==null?1:params.page, //分页
                        pageSize: 10	//分页大小
                    };
                },
                processResults: function (data, params) {
                    params.page = params.page || 1;
                    return {
                        results: data.items,
                        pagination: {
                            more: (params.page * 10) < data.total
                        }
                    };
                },
                cache: true
            },
            escapeMarkup: function (markup) { return markup; }, // let our custom formatter work
            minimumInputLength: 0,
            templateSelection: function(repo){
            	if(repo.text!='' && repo.text!='undefined' && repo.text!='请选择'){
            		var bootstrapValidator = $("#inputForm").data('bootstrapValidator');  
    			    bootstrapValidator.updateStatus('userIdNum', 'NOT_VALIDATED').validateField('userIdNum');
                	if(repo.userType!=''){
	    			    $("select[name='userType']").val(repo.userType);
                	}
            	}
            	$("input[name='personnel.id']").val(repo.id);
            	$("input[name='userName']").val(repo.text);
           	 	$("input[name='userIdNum']").val(repo.idNumber);
            	return repo.text;
            }
		});
	});
	
	function resetForm(){
		$("input[name='id']").val('');
		$("input[name='personnel.id']").val('');
		$("input[name='annexIds']").val('');
		$("input[name='dataFrom']").val('manual');
		$("td[name='atte_infomation_annexes_td']").html('');
		$('#inputForm').bootstrapValidator('resetForm', true);
	}
	
	//初始化列表
	var TableInit = function () {
	    var oTableInit = new Object();
	    //初始化Table
	    oTableInit.Init = function () {
	        $('#dataList').bootstrapTable({
	        	url: CTX + 'atte-infomation/query-atte-infomation-page',         //请求后台的URL（*）
	            method: 'get',                      //请求方式（*）
	            toolbar: '#toolbar',                //工具按钮用哪个容器
	            striped: true,                      //是否显示行间隔色
	            cache: false,                       //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
	            pagination: true,                   //是否显示分页（*）
	            sortable: true,                     //是否启用排序
	            sortOrder: "desc",                   //排序方式
	            sortName: 'swipeTime',
	            queryParams: oTableInit.queryParams,//传递参数（*）
	            sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
	            pageNumber:1,                       //初始化加载第一页，默认第一页
	            pageSize: 10,                       //每页的记录行数（*）
	            pageList: [10, 25, 50, 100],        //可供选择的每页的行数（*）
	            queryParamsType: "a",
	            search: true,                       //是否显示表格搜索
	            strictSearch: true,
	            showColumns: true,                  //是否显示所有的列
	            showRefresh: true,                  //是否显示刷新按钮
	            minimumCountColumns: 2,             //最少允许的列数
	            clickToSelect: true,                //是否启用点击选中行
	            height: $(window).height()-80,      //行高，如果没有设置height属性，表格自动根据记录条数觉得表格高度
	            uniqueId: "id",                     //每一行的唯一标识，一般为主键列
	            showToggle:true,                    //是否显示详细视图和列表视图的切换按钮
	            cardView: false,                    //是否显示详细视图
	            detailView: false,                  //是否显示父子表
	            columns: [
				{
	            	checkbox:true
		        },{
				    field: 'companyName',
				    title:'单位名称'
				},{
				    field: 'userName',
				    title:'人员姓名',
				    sortable:true
				},{
				    field: 'userIdNum',
				    title:'人员身份证',
				    sortable:true
				},{
				    field: 'userType',
				    title:'人员类型',
				    sortable:true,
				    formatter:function(v,r,i){
				    	return v=='01'?'管理人员':'务工人员';
				    }
				},{
				    field: 'swipeTime',
				    title:'刷卡时间',
				    sortable:true,
				    formatter:function(v,r,i){
				    	return (new Date(v)).Format('yyyy-MM-dd hh:mm:ss');
				    }
				},{
				    field: 'swipeStatus',
				    title:'刷卡状态',
				    sortable:true,
				    formatter:function(v,r,i){
				    	return v==1?'进入工地':'离开工地';
				    }
				},{
				    field: 'hasPic',
				    title:'考勤照片',
				    align : 'center',
				    clickToSelect : false,
				    formatter:function(v,r,i){
				    	var htmlStr = '';
				    	if(v){
				    		htmlStr = '<button type="button" onclick="window.top.openCommonViewImgWin(\''+r.annexIds+'\')" style="background: none; border:none;"><i class="fa fa-check text-aqua"></i></button>';
				    	}else{
				    		htmlStr = '<i class="fa fa-close text-red"></i>';
				    	}
				    	return htmlStr;
				    }
				},{
				    field: 'cz',
				    title:'操作',
				    align : 'center',
					valign : 'middle',
					clickToSelect : false,
                    formatter: function (v, r, i) {
                    	var operateHtml = '<button type="button" onclick="doShowDetail(\''+r.id+'\')" style="background: none; border:none;"><i class="fa fa-search"></i></button>';
                        return operateHtml;
                    }
				}
				]
	        });
	        $('.search input').attr('placeholder','人员姓名');
	    };

	    //得到查询的参数
	    oTableInit.queryParams = function (params) {
	    	var data = JSON.stringify($('#formSearch').serializeJSON());
	        var temp = {   //这里的键的名字和控制器的变量名必须一致，这边改动，控制器也需要改成一样的
	    		pageNum: params.pageNumber,//页码params.offset
                size: params.pageSize,//页面大小params.limit
                order: params.sortOrder,//排序 params.order
                ordername: params.sortName,//排序字段 params.sort
                form: data,
	            //content:$("#formSearch input[id=query_content_like]").val(),
	            search:params.searchText
	        };
	        return temp;
	    };
	    return oTableInit;
	};
	
	
	//查询-刷新
	var queryInfo = function(){
		var data = JSON.stringify($('#formSearch').serializeJSON());
		var queryData = {form: data};
		$('#dataList').bootstrapTable('refresh',{pageNumber:1,pageSize:10,query:queryData});
	}
	
	$('#toolbar button').on('click',function(){
		//新增
		if($(this).attr('id')=='btn_add'){
			if($("input[name='projectInfo.id']").val()==''){
				alert('暂无项目信息,请先添加项目');
				return;
			}
			$('#addModal').find('.modal-title').html('新增信息');
			$('#addModal').modal('toggle');
		}
		//删除
		if($(this).attr('id')=='btn_delete'){
			doDelete();
		}
	});
	
	function doShowDetail(id){
		$('#viewModal').modal('toggle');
		$.ajax({
			url: CTX+'atte-infomation/get-atte-infomation',
			type: 'get',
			dataType: 'json',
			data:{id:id},
			success: function(json){
				if(json){
					var info = json.data;
					$('#user_name').html(info.userName);
					$('#user_id_num').html(info.userIdNum);
					$('#has_pic').html(info.hasPic==true?'是':'否');
					$('#swipe_status').html(info.swipeStatus==1?'进入工地':'离开工地');
					$('#swipe_time').html((new Date(info.swipeTime)).Format('yyyy-MM-dd hh:mm:ss'));
					$('#user_type').html(info.userType=='01'?'管理人员':'务工人员');
					if(json.annexes!=null){
						var htmlStr = '';
						$.each(json.annexes,function(i,annex){
							htmlStr += '<img src="'+STATIC+annex.relativePath+'"/>';
						});
						$('.form_img').html(htmlStr);
					}
				}
			}
		});
	}
	
	function doSave(isnext){
		var result = $('#inputForm').data('bootstrapValidator');
		result.validate();
		if(result.isValid()){
			loading('正在保存,请稍后...');
			$.ajax({
				url: CTX+'atte-infomation/save-atte-infomation',
				type: 'post',
				dataType: 'json',
				data: $("#inputForm").serialize(),
				timeout: 10000,
				success: function(json){
					loaded();
					alert(json.msg);
					if(json.success){
						queryInfo();
						if(isnext){
							resetForm();
						}else{
							$('#addModal').modal('toggle');
						}
					}
				},
				error: function(){
					alert('请求超时或系统出错!');
					loaded();
				}
			});
		}
	}
	

	//删除
	var doDelete = function(){
		var seldatas = $('#dataList').bootstrapTable('getSelections');
		if(seldatas.length<=0){
			alert('未选择删除项');
			return;
		}else{
			if(window.confirm('确定要删除所选项吗?')){
				loading('正在删除,请稍后...');
				var delIds = '';
				$.each(seldatas,function(i,seldata){
					delIds += ','+seldata.id;
				});
				delIds = delIds.substring(1);
				$.ajax({
					url:CTX+'atte-infomation/delete-atte-infomation',
					type:'POST',
					data:{ids:delIds},
					dataType:'json',
					success:function(json){
						loaded();
						if(json.success){
							alert(json.msg);
							queryInfo();
						}else{
							alert(json.msg);
						}
					},
					error:function(){
						alert('请求超时或系统出错!');
						loaded();
					}
				});
			}
		}
	}
	
	function fnEditAnnex(tdEl,folderId,folderName){
		var annexIdStr = '';
		var fields_tdEl = $(tdEl).parent().prev().prev();
		if(fields_tdEl.find("input[name='fieldIds']").length>0){
			fields_tdEl.find("input[name='fieldIds']").each(function(){
				annexIdStr += ','+$(this).val();
			});
			annexIdStr = annexIdStr.substring(1);
		}
		//调用统一附件管理页面
		window.top.openUploadAnnexWin({
			folderId:folderId,
			folderName:folderName,
			annexIds:annexIdStr
		},function(data){
			//附件管理回调
			if(data.length>0){
				var htmlStr = '';
				$.each(data,function(i,annex){
					htmlStr += 
						'<p>'+
		              	'	<input type="hidden" name="fieldIds" value="'+annex.id+'"/>'+
		              	'	<a href="javascript:window.top.openCommonViewImgWin(\''+annex.id+'\')">'+annex.name+'.'+annex.extendName+'</a>'+
		              	'</p>';
				});
				$(tdEl).parent().prev().prev().html(htmlStr);
			}else{
				$(tdEl).parent().prev().prev().html('无');
			}
			if($("input[name='fieldIds']").length>0){
				var annexIdStr = '';
				$("input[name='fieldIds']").each(function(){
					annexIdStr += ','+$(this).val();
				});
				$('#inputForm').find("input[name='annexIds']").val(annexIdStr.substring(1));
			}else{
				$('#inputForm').find("input[name='annexIds']").val('');
			}
		});
	}
/*]]>*/
</script>	
</html>
