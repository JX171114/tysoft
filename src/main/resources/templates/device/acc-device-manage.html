<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<!--
* @Copyright(c): 厦门路桥信息股份有限公司  版权所有
* @author :Administrator
* @Description:门禁设备表管理 
* @createDate:2018-3-12
-->
<head>
<meta http-equiv="pragma" content="no-cache" />
<meta http-equiv="Cache-Control" content="no-cache" />
<meta http-equiv="Cache-Control" content="no-store" />
<meta http-equiv="Expires" content="0" />
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta
	content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
	name="viewport" />
<title>门禁设备表管理</title>

	<!-- Bootstrap 3.3.7 -->
	<link rel="stylesheet" th:href="@{/static/dist/css/AdminLTE.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/bootstrap/css/bootstrap.min.css}" />
	<link rel="stylesheet" th:href="@{/static/plugins/bootstrap-table/dist/bootstrap-table.min.css}" />
	<link rel="stylesheet" th:href="@{/static/plugins/datetimepicker/css/bootstrap-datetimepicker.css}" />
	<!-- fa icon -->
	<link rel="stylesheet" th:href="@{/static/dist/css/font-awesome.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/dist/css/ionicons.min.css}"/>
	<!-- Bootstrap-treeview -->
	<link rel="stylesheet" th:href="@{/static/plugins/bootstrap-treeview/bootstrap-treeview.min.css}" />
</head>
<body>
	<div class="container-fluid">
		<input type="hidden" id="projectInfoId" th:value="${projectInfo}!=null?${projectInfo.id}:''"/>
		<div id="toolbar" class="btn-group">
			<button id="btn_add" type="button"
				class="btn btn-default btn-primary">
				<span class="glyphicon glyphicon-plus" aria-hidden="true"></span>新增
			</button>
			<button id="btn_edit" type="button"
				class="btn btn-default btn-warning">
				<span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>修改
			</button>
			<button id="btn_delete" type="button"
				class="btn btn-default btn-danger">
				<span class="glyphicon glyphicon-remove" aria-hidden="true"></span>删除
			</button>
		</div>
		<table id="dataList"></table>
	</div>

	 <!-- 模态框 -->
    <div class="modal fade" id="addModal" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static" aria-hidden="true">
		<div class="modal-dialog" role="document" style="width:800px">
			<div class="modal-content">
				<div class="modal-header">
				 	<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
					<h4 class="modal-title">门禁设备表管理</h4>
				</div>
				<div class="modal-body" style="overflow: hidden; padding: 10px;">
				<form id="inputForm" class="form-horizontal">
					<input type="hidden" id="id" name="id" value=""/>
		          	<input type="hidden" name="projectInfo.id" th:value="${projectInfo}!=null?${projectInfo.id}:''"/>
		            <div class="row">
					 <div class="col-md-6">
            			<div class="form-group">
		                  	<label class="col-sm-4 control-label"><i style="color:red;">*</i>&nbsp;门禁编号:</label>
		                  	<div class="col-sm-8">
	                    	 <input type="text" class="form-control" name="accNo" value="" />
		                  	</div>
		                </div>
		                <div class="form-group">
		                  	<label class="col-sm-4 control-label"><i style="color:red;">*</i>&nbsp;IP地址:</label>
		                  	<div class="col-sm-8">
		                  	 <input type="text" class="form-control" name="ipAddr"/>
		                  	</div>
		                </div>
		                <div class="form-group">
		                  	<label class="col-sm-4 control-label"><i style="color:red;">*</i>&nbsp;安装地址:</label>
		                  	<div class="col-sm-8">
		                 		<input type="text" class="form-control" name="installAddr" value=""/>
		                  	</div>
		                </div>
		                <div class="form-group">
		                  	<label class="col-sm-4 control-label">出入场类型:</label>
		                  	<div class="col-sm-8">
		               		  	<select class="form-control" name="swipeStatus">
		               		  		<option value="" >请选择</option>
	                    			<option value="1" >进入工地</option>
	                    			<option value="2" >离开工地</option>
	                    		</select>
		                  	</div>
		                </div>
            		</div>
            		<div class="col-md-6">
            			<div class="form-group">
		                  	<label class="col-sm-4 control-label"><i style="color:red;">*</i>&nbsp;门禁名称:</label>
		                  	<div class="col-sm-8">
	                    	<input type="text" class="form-control" name="accName" value=""/> 
		                  	</div>
		                </div>
		                <div class="form-group">
		                  	<label class="col-sm-4 control-label"><i style="color:red;">*</i>&nbsp;安装时间:</label>
		                  	<div class="col-sm-8">
	                    	<input type="text" class="form-control update datetimepicker" readonly="readonly" name="installTime" id="installTime" value=""/>
		                  	</div>
		                </div>
		                <div class="form-group">
		                  	<label class="col-sm-4 control-label"><i style="color:red;">*</i>&nbsp;是否采集设备:</label>
		                  	<div class="col-sm-8">
			                    <select name="isDefault" class="form-control">
				                  <option value="false" >否</option>
				                  <option value="true" >是</option>
				                 </select>
		                  	</div>
		                </div>
            		</div>
				</div>
				</form>
				</div>
				<div class="modal-footer">
					 <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button> 
					 <button id="btnSubmit" type="button" onclick="doSave()" class="btn btn-primary">保存</button>
				</div>
			</div>
		</div>
	</div>
	
		<!-- 设备有效入场人员 -->
	<div class="modal fade" id="selection_personnel_modal" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static" aria-hidden="true">
		<div class="modal-dialog" style="width:800px;">
			<div class="modal-content">
				<div class="modal-header" style="text-align: center;background-color: #357ca5;">
				 	<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
					<h4 class="modal-title" style="color:white;">设备入场人员</h4>
				</div>
				<div class="modal-body" style="overflow: hidden; padding: 10px;">
				<form class="form-horizontal" id="selection_personnel_form">
					<input type="hidden" id="id" name="id" value=""/>
						<div class="box box-default box-solid" style="margin-bottom:5px;">
				            <div class="box-header with-border">
				              	<h3 class="box-title">选中人员</h3>
				              	<button type="button" class="btn btn-primary" onclick="removeAllPersonnels()" style="color: #FFFFFF;background: transparent;border:none;outline:none;">全部移除</button>
				              	<div class="box-tools pull-right">
				                	<button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
				             	</div>
				              	<!-- /.box-tools -->
				            </div>
				            <!-- /.box-header -->
				            <div class="box-body" id="selected_personnel">
				            </div>
				        </div>
				        <div class="box box-default box-solid" style="margin-bottom:5px;">
				            <div class="box-header with-border">
				              	<h3 class="box-title">待选列表</h3>
				              	<div class="box-tools pull-right">
				                	<button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
				             	</div>
				              	<!-- /.box-tools -->
				            </div>
				            <!-- /.box-header -->
				            <div class="box-body">
									<div class="row ">
										<div class="col-md-6" style="padding-right: 0px;padding-left: 10px;">
											<div class="panel panel-primary " style="Border:None;radius:0px">
												<div class="panel-heading">
													<h3 class="panel-title">单位类型</h3>
												</div>
												<div class="panel-body left_centent" style="height: 458px;overflow: auto;radius:0px">
													<div id="left-tree"></div>
												</div>
											</div>
										</div>
										<div class="col-md-6" style="height: 458px;padding-right: 10px;padding-left: 0px;">
											<div class="panel panel-primary "  style="border:none;radius:0px;height: 496px;">
												<div class="panel-heading">
													<h3 class="panel-title">选择人员</h3>
												</div>
											<!--编辑操作权限 start-->
							                <div class="panel-body right_centent" style="height: 458px;overflow: auto;radius:0px">
							                <div  id="editShow">
							                <table class="table table-bordered" >
								                <tbody id="personnel_info_tbody" >		               
								                </tbody>
							              	</table>
							                </div>
							                </div>
							                 <div style="margin-top: 20px;margin-bottom: 10px;padding-left: 68%;">
							                  	<button type="button" class="btn btn-primary" onclick="swapCheck()" >全部选中</button>
								              </div>
							                 <div style="margin-bottom: 20px;padding-left:50%;">
							                 	<button type="button" class="btn btn-default" data-dismiss="modal" >取&nbsp;&nbsp;&nbsp;&nbsp;消</button>
								                 <button id="btnSubmit" type="button" onclick="doSavePersonnel()" class="btn btn-primary">保&nbsp;&nbsp;&nbsp;&nbsp;存</button>
								              </div>
							                <!--编辑操作权限 end-->
											</div>
										</div>
									</div>
				            </div>
				        </div>
	            	</form>
				</div>
			</div>
		</div>
	</div>
</body>
<!-- jQuery 2.2.3 -->
<script th:src="@{/static/plugins/jQuery/jquery-2.2.3.min.js}"></script>
<!-- Bootstrap 3.3.7 -->
<script th:src="@{/static/bootstrap/js/bootstrap.min.js}"></script>
<script th:src="@{/static/js/common.js}"></script>
<script th:src="@{/static/plugins/bootstrap-validator/js/bootstrapValidator.min.js}"></script>
<script th:src="@{/static/plugins/bootstrap-table/dist/bootstrap-table.min.js}"></script>
<script th:src="@{/static/plugins/bootstrap-table/dist/locale/bootstrap-table-zh-CN.min.js}"></script>
<script th:src="@{/static/plugins/jQuery/jquery.serializejson.min.js}"></script>
<script th:src="@{/static/plugins/datetimepicker/js/bootstrap-datetimepicker.js}"></script>  
<script th:src="@{/static/plugins/datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js}"></script>  
<script th:src="@{/static/plugins/bootstrap-table/dist/extensions/export/bootstrap-table-export.min.js}"></script>
<script th:src="@{/static/plugins/bootstrap-table/dist/extensions/export/tableExport.js}"></script> 
<!-- Inputmask  -->
<script th:src="@{/static/plugins/input-mask/jquery.inputmask.js}"></script>
<script th:src="@{/static/plugins/input-mask/jquery.inputmask.extensions.js}"></script>
<!-- Bootstrap-treeview -->
<script th:src="@{/static/plugins/bootstrap-treeview/bootstrap-treeview.js}"></script>
<script th:src="@{/static/plugins/bootstrap-treeview/bootstrap-treeview.min.js}"></script>
<script th:inline="javascript" type="text/javascript">
/*<![CDATA[*/
	var CTX = [[@{/}]];
	$(function () {
	    //1.初始化Table
	    var oTable = new TableInit();
	    oTable.Init();

	    //2.初始化Button的点击事件
	    var oButtonInit = new ButtonInit();
	    oButtonInit.Init();
	    
	    //格式化ip地址输入框  不兼容 暂时去掉
	    //$('.myipaddress').inputmask({alias:"ip"});

	    //初始化时间控件
	    $('.datetimepicker').datetimepicker({
	    	format:"yyyy-mm-dd hh:ii:ss",
	    	language:"zh-CN",
	    	todayHighlight:true,
	    	todayBtn:true,
	    	autoclose: true
	    	}).on('hide',function(){
				if($(this).val()!=''){
					var bootstrapValidator = $("#inputForm").data('bootstrapValidator');  
				    bootstrapValidator.updateStatus($(this).attr('name'), 'NOT_VALIDATED').validateField($(this).attr('name'));
				}
			});
	    
	   
	    
	    //验证表单内容
	    $('#inputForm').bootstrapValidator({
			message: '此处输入有误',
	        excluded: [':disabled'],
	        feedbackIcons: {
	            valid: 'glyphicon glyphicon-ok',
	            invalid: 'glyphicon glyphicon-remove',
	            validating: 'glyphicon glyphicon-refresh'
	        },
	        fields:{
	        	'accNo':{
	        		message: '门禁编号输入不合法',
	                validators: {
	                    notEmpty: {
	                        message: '门禁编号不可为空'
	                    }
	                }
	        	},
	        	'accName':{
	        		message: '门禁名称输入不合法',
	                validators: {
	                    notEmpty: {
	                        message: '门禁名称不可为空'
	                    }
	                }
	        	},
	        	'ipAddr':{
	        		message: 'IP地址输入不合法',
	                validators: {
	                    notEmpty: {
	                        message: 'IP地址不可为空'
	                    }
	                }
	        	},
	        	'installTime':{
	        		message: '安装时间输入不合法',
	                validators: {
	                    notEmpty: {
	                        message: '安装时间不可为空'
	                    }
	                }
	        	},
	        	'installAddr':{
	        		message: '安装地址输入不合法',
	                validators: {
	                    notEmpty: {
	                        message: '安装地址不可为空'
	                    }
	                }
	        	},
	        	'isDefault':{
	        		message: '是否默认采集设备输入不合法',
	                validators: {
	                    notEmpty: {
	                        message: '是否默认采集设备不可为空'
	                    }
	                }
	        	}
	        }
		});
	    
	});
	
	//初始化列表
	var TableInit = function () {
	    var oTableInit = new Object();
	    //初始化Table
	    oTableInit.Init = function () {
	    	var value = $("#projectInfoId").val();
	        $('#dataList').bootstrapTable({
	        	url: CTX + 'acc-control-device/query-acc-control-device-page?projectInfoId='+value,         //请求后台的URL（*）
	            method: 'get',                      //请求方式（*）
	            toolbar: '#toolbar',                //工具按钮用哪个容器
	            //toolbarAlign:'left',				//工具栏位置
	            striped: false,                      //是否显示行间隔色
	            cache: false,                       //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
	            pagination: true,                   //是否显示分页（*）
	            sortable: false,                     //是否启用排序
	            sortOrder: "asc",                   //排序方式
	            queryParams: oTableInit.queryParams,//传递参数（*）
	            sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
	            pageNumber:1,                       //初始化加载第一页，默认第一页
	            pageSize: 10,                       //每页的记录行数（*）
	            pageList: [10, 25, 50, 100],        //可供选择的每页的行数（*）
	            queryParamsType: "a",
	            search: true,                       //是否显示表格搜索
	            strictSearch: true,
	            showColumns: true,                  //是否显示所有的列
	            showRefresh: true,                  //是否显示刷新按钮
	            minimumCountColumns: 2,             //最少允许的列数
	            clickToSelect: true,                //是否启用点击选中行
	            height: $(window).height(),         //行高，如果没有设置height属性，表格自动根据记录条数觉得表格高度
	            uniqueId: "id",                     //每一行的唯一标识，一般为主键列
	            showToggle:true,                    //是否显示详细视图和列表视图的切换按钮
	            cardView: false,                    //是否显示详细视图
	            detailView: false,                  //是否显示父子表
	            showExport: false,                     //是否显示导出
	            exportDataType: "basic",              //basic', 'all', 'selected'.
	            exportTypes:[ 'excel','doc', 'xml','csv','json'],  //导出文件类型
	            exportOptions:{  
	                ignoreColumn: [0],  //忽略某一列的索引 ,如 [0,1]
	                fileName: '门禁设备表导出',  //文件名称设置  
	                worksheetName: '信息',  //表格工作区名称  
	                tableName: '门禁设备表导出文件'
	            },
	            columns: [
				{
	            	checkbox:true
		        },{
				    field: 'accNo',
				    title:'门禁编号',
				    sortable:true,
				    align : 'center',
				},{
				    field: 'accName',
				    title:'门禁名称',
				    sortable:true,
				    align : 'center',
				},{
				    field: 'ipAddr',
				    title:'IP地址',
				    sortable:true,
				    align : 'center',
				},{
				    field: 'installTime',
				    title:'安装时间',
				    sortable:true,
				    align : 'center',
				    formatter : function(v) {
				    return new Date(v).Format('yyyy-MM-dd hh:mm:ss');
					}
				},{
				    field: 'installAddr',
				    title:'安装地址',
				    align : 'center',
				    sortable:true
				},{
				    field: 'status',
				    title:'设备状态',
				    sortable:true,
				    align : 'center',
				    formatter: function (value, row, index) {
                        if (value == 1) {return '<span class="label label-success">在线</span>';}
                        else{return '<span class="label label-danger">离线</span>';}
                    }
				},{
					field : 'operate',
					title : '操作',
					align : 'center',
					valign : 'middle',
					clickToSelect : false,
                    formatter: function (value, row, index) {
                    	var operateHtml = '<button type="button" onclick="doEdit(\''+row.id+'\')" style=" background: none; border:none;"><i class="fa fa-edit" style="color:green;"></i>&nbsp;</button> &nbsp;';
                    	//operateHtml = operateHtml + '<button type="button" onclick="doSelect(\''+row.id+'\')" style=" background: none; border:none;"><i class="fa fa-group" style="color:#00c0ef;"></i>&nbsp;</button> &nbsp;';
                    	//operateHtml = operateHtml + '<button type="button" onclick="grant(\''+row.id+'\')" style=" background: none; border:none;"><i class="fa fa-sign-in" style="color:#00c0ef;"></i>&nbsp;</button>';
                        return operateHtml;
                    }
				}, ]
	        });
	    };

	    //得到查询的参数
	    oTableInit.queryParams = function (params) {
	    	var data = JSON.stringify($('#formSearch').serializeJSON());
	        var temp = {   //这里的键的名字和控制器的变量名必须一致，这边改动，控制器也需要改成一样的
	    		pageNum: params.pageNumber,//页码params.offset
                size: params.pageSize,//页面大小params.limit
                order: params.sortOrder,//排序 params.order
                ordername: params.sortName,//排序字段 params.sort
                from:data,
	            //content:$("#formSearch input[id=query_content_like]").val(),
	            search:params.searchText
	        };
	        return temp;
	    };
	    return oTableInit;
	};
	
	//初始化按钮
	var ButtonInit = function () {
	    var oInit = new Object();
	    var postdata = {};

	    oInit.Init = function () {
	        //初始化页面上面的按钮事件
	    };

	    return oInit;
	};
	
	//查询-刷新
	var queryInfo = function(){
		var data = JSON.stringify($('#formSearch').serializeJSON());
		var queryData = {from: data};
		$('#dataList').bootstrapTable('refresh',{pageNumber:1,pageSize:10,query:queryData});
	}
	
	$('#toolbar button').on('click',function(){
		//新增
		if($(this).attr('id')=='btn_add'){
			if($("#projectInfoId").val()==''){
				alert('暂无项目信息');
				return;
			}
			$('#inputForm').find("input[name='id']").val('');
			$('#inputForm')[0].reset();//清空表单
			$('#inputForm').bootstrapValidator('resetForm');//重置表单校验:
			$('#addModal').find('.modal-title').html('新增信息');
			$('#addModal').modal('toggle');
			
		}
		 //编辑
		if($(this).attr('id')=='btn_edit'){
			var id=0;
			doEdit(id);
		}
		//删除
		if($(this).attr('id')=='btn_delete'){
			doDelete();
		}
	});
	
	//删除
	var doDelete = function(){
		var seldatas = $('#dataList').bootstrapTable('getSelections');
		if(seldatas.length == 0){
			alert('未选择删除项');
			return;
		}else{
			if(window.confirm('确定要删除所选项吗?')){
				loading('正在删除,请稍后...');
				var delIds = '';
				$.each(seldatas,function(i,seldata){
					delIds += ','+seldata.id;
				});
				delIds = delIds.substring(1);
				$.ajax({
					url:CTX+'acc-control-device/delete-acc-control-device',
					type:'POST',
					data:{ids:delIds},
					dataType:'json',
					success:function(json){
						loaded();
						if(json.success){
							alert(json.msg);
							queryInfo();
						}else{
							alert(json.msg);
						}
					},
					error:function(){
						alert('请求超时或系统出错!');
						loaded();
					}
				});
			}
		 } 
	}
	
	
	//编辑
	var doEdit = function(id){
		if(id.length>=0){
			var id=id;
		}else
		{
		var seldatas = $('#dataList').bootstrapTable('getSelections');
		if(seldatas.length==0){
			alert('请选择一项来编辑');
			return;
		}
		if(seldatas.length>1){
			alert('只会编辑所选的第一项');
		}
		var selData = seldatas[0];
		var id=selData.id;
		}
		$('#inputForm').find("input[name='id']").val('');
		$('#inputForm').bootstrapValidator('resetForm');//重置表单校验:
		$('#addModal').find('.modal-title').html('编辑信息');
		$('#addModal').modal('toggle');
		$.ajax({
			url:CTX+'acc-control-device/get-acc-control-device',
			type:'GET',
			data:{id:id},
			dataType:'json',
			success:function(json){
				if(json){
					$('#inputForm').find("input[name='id']").val(json.id);
					$('#inputForm').find("input[name='accNo']").val(json.accNo);
					$('#inputForm').find("input[name='accName']").val(json.accName);
					$('#inputForm').find("input[name='ipAddr']").val(json.ipAddr);
					$('#inputForm').find("input[name='installTime']").val(new Date(json.installTime).Format('yyyy-MM-dd hh:mm:ss'));
					$('#inputForm').find("input[name='installAddr']").val(json.installAddr);
					if(json.isDefault){
						$('#inputForm').find("select[name='isDefault']").val("true");
					}else{
						$('#inputForm').find("select[name='isDefault']").val("false");
					};
					$('#inputForm').find("select[name='swipeStatus']").val(json.swipeStatus);
				}
			},
			error:function(){
				alert('请求超时或系统出错!');
				$('#addModal').modal('hide');
			}
		});
	}
	
	
	
	//保存
	function doSave(){
		var result = $('#inputForm').data('bootstrapValidator');
		result.validate();
		if(result.isValid()){
			console.log($("#inputForm").serialize());
			loading('正在保存,请稍后...');
		$.ajax({  
			url: CTX+'acc-control-device/save-acc-control-device',
            type: 'POST',  
            data:$('#inputForm').serialize(),// 序列化表单值  
            dataType: 'json',//服务端接收的数据类型
            success:function(json) {  
            	loaded();
				if(json.success){
					alert(json.msg);
					queryInfo();
					$("#addModal").modal('hide');
				}else{
					alert(json.msg);
				}
            },  
            error:function(json) {  
            	alert('请求超时或系统出错!');
				loaded();
            }  
        });  
		}
	}
	
	
	//选择门禁设备有效入场人员
	var doSelect = function(id){
	$('#selection_personnel_modal').find("input[name='id']").val('');
    $('.allPersonnels').remove();
    $("input[name='checkbox']").prop('checked',false);
	$('.personnel_info_tr').remove();
	$('#selection_personnel_modal').find("input[name='id']").val(id);
	$('#selection_personnel_modal').find('.modal-title').html('门禁设备有效入场人员');
	$('#selection_personnel_modal').modal('toggle');
	var r = Math.random().toString().substring(5);
     	 $.ajax({
             type: "GET",
             url: CTX+'acc-control-device/get-sort-json?Mathnum=' + r,
             data: {accId:id},
             dataType: "json",
             success: function(data){
            	 /* 处理如果该设备以及有人了，就显示在已选区域 */
            	 $.each(data.personnels,function(i,personnel){
            		 appendPersonnel(personnel.id,personnel.name);
            	 });
            	 /* 显示树 */
                 $('#left-tree').treeview({
                        data: eval('['+data.StrJSON+']'),    
                        levels:1,
                        expandIcon:"fa fa-chevron-down",
                        collapseIcon:"fa fa-chevron-up",
                        onNodeSelected: function(event, data) {
                        	doViewPersonnel(data['id'],data['levels']);
                          }
                    });
             },
             error: function(XMLHttpRequest, textStatus, errorThrown) {
                 alert(XMLHttpRequest.status);
                 alert(XMLHttpRequest.readyState);
                 alert(textStatus);
               }
         });
        }
	
	
	/*-----页面pannel内容区高度自适应 start-----*/
	$(window).resize(function () {
		setCenterHeight();
	});
	setCenterHeight();
	function setCenterHeight() {
		var height = $(window).height();
		var centerHight = height - 240;
		$(".right_centent").height(centerHight).css("overflow", "auto");
	}
	/*-----页面pannel内容区高度自适应 end-----*/
	
	var doViewPersonnel = function(id,levels){
		var r = Math.random().toString().substring(5);
			$.ajax({
				url: CTX+'acc-control-device/find-personnel-info?Mathnum=' + r,
				type: 'get',
				dataType: 'json',
				data: {"id":id,"levels":levels},
				timeout: 10000,
				success: function(json){
					var htmlStr = '';
					if(json.length>0){
					$('.personnel_info_tr').remove();
					  $.each(json,function(i,json){
						  htmlStr +=  
			                '<tr class="personnel_info_tr">'+
			                '	<td style="text-align:center;border-left:0px;border-right:0px;">'+'<li class="ion ion-person" style="font-size:50px;"> </li>'+'</td>'+
			                '	<td style="text-align:left;padding-top: 20px;border-left:0px;border-right:0px;">'+json.name+'</td>'+
			                '	<td style="text-align:center;padding-top: 20px;border-left:0px;border-right:0px;">'+
			               /*  ' 		<div class="icheckbox_minimal-blue" aria-checked="false" aria-disabled="false" style="position: relative;">'+
			                ' 		<input type="checkbox" class="minimal" checked="" style="position: absolute; opacity: 0;"/>'+
			                ' 		<ins class="iCheck-helper" style="position: absolute; top: 0%; left: 0%; display: block; width: 100%; height: 100%; margin: 0px; padding: 0px; background: rgb(255, 255, 255); border: 0px; opacity: 0;">'+
			                ' 		</ins>'+
			                ' 		</div>'+ */
			                '	<input type="checkbox" name="checkbox" onChange="change(this)" value="'+json.id+'" field="'+json.name+'" class="name'+json.id+'"/>'+
			                '	</td>'+
			                '</tr>';
					  });
					  
					  $('#personnel_info_tbody').append(htmlStr);
					  /* 如果已经选中，则设置为checked */
					  $.each(json,function(i,json){
					  if(getAllPersonnels(json.id)==false){
						  $('.name'+json.id+'').prop('checked',true);
						  }
					  });
				}else{
					 $('.personnel_info_tr').remove();
				}
			},
				error: function(){
					alert('请求超时或系统出错!');
				}
			});
		
	}
	
	 //checkbox 全选/取消全选  
  /*   function swapCheck() {  
    	 var isCheckAll = false;  
        if (isCheckAll) {  
            $("input[type='checkbox']").each(function() {  
                this.checked = false;  
            });  
            isCheckAll = false;  
        } else {  
            $("input[type='checkbox']").each(function() {  
                this.checked = true;  
            });  
            isCheckAll = true;  
        }  
    }   */
    
    // 全选
    function swapCheck() {  
   		$("input[name='checkbox']").prop('checked',true);
   		$("input[name='checkbox']").each(function(){
   			var id = $(this).val();
   			var name = $(this).attr('field');
   			 appendPersonnel(id,name);
   		});
   } 
	 
    //判断单选和取消
    function change(selecte){  
    	var id=selecte.value;
		var name=$('.name'+id).attr('field');
    	if($(selecte).is(':checked')){
    		 appendPersonnel(id,name);
    	}else{
   		    removePersonnel(id);
    	}
    } 
    
    var appendPersonnel = function(id,name){
    var htmlStr = '';	
    if(id!=null&&name!=null){
    htmlStr +=  
    	'<div id="selected_psersonnel'+id+'" class="allPersonnels" style="background-color:#3c8fe0c4;color:white;width:auto;hight:60px;float:left;margin:5px;">'+
        '	<input type="hidden" name="personnel_id" class="personnelId" value="'+id+'"/>'+
        '<spand style="padding-left: 5px;padding-right: 5px;">'+name+'</spand>'+
        '	<input type="button" class="closeDiv" onclick="removePersonnel(\''+id+'\')" value="X" style="background:transparent;border:none;"/>'+
        '</div>';
        /* 如果人员已经存在，则不加入 */
      if(getAllPersonnels(id)!=false){
    	  $('#selected_personnel').append(htmlStr);
   	 }
    }
   }
    
    /* 单个移除 */
    var removePersonnel = function(id){
      
          $('#selected_psersonnel'+id).remove();
          $('.name'+id).prop('checked',false);
          var id=[id];
          doDeletePersonnel(id);
          
    }
    
    /*全部移除*/
     var removeAllPersonnels = function(){
	    	// 得到页面中所有input
	 		var allInputs = document.getElementsByTagName('input');
	 		var Ids = [];
	 		// 在所有Input中过滤出type="hidden" and name="personnel_id"的元素，放到数组libIds中
	 		for (var i =0; i < allInputs.length; i++) {
	 			if (allInputs[i].type === 'hidden' && allInputs[i].name === 'personnel_id') {
	 				Ids.push(allInputs[i].value);
	 			}
	 		}
	 	  doDeletePersonnel(Ids);
          $('.allPersonnels').remove();
          $("input[name='checkbox']").prop('checked',false);
    }
    
  
     /* 获取人员 判断是否存在*/
     function getAllPersonnels(id) {
    		// 得到页面中所有input
    		var allInputs = document.getElementsByTagName('input');
    		var Ids = [];
    		// 在所有Input中过滤出type="hidden" and name="personnel_id"的元素，放到数组libIds中
    		for (var i =0; i < allInputs.length; i++) {
    			if (allInputs[i].type === 'hidden' && allInputs[i].name === 'personnel_id') {
    				Ids.push(allInputs[i].value);
    			}
    		}
    		/* 判断是否已存在人员 已存在就返回false */
    		for(var j=0;j<Ids.length;j++){
    		if(id === Ids[j]){
	            return false;
	        	}
    		}
     }
    
     /* 保存有效入场人员 */
     function doSavePersonnel() {
    	 var ids=[];
    	 ids= getPersonnels();//获取所有人员id
    	 var accId= $('#selection_personnel_form').find("input[name='id']").val();//设备Id
    	 if(ids.length>0 && accId!=null){
    		 $.ajax({
 				url: CTX+'acc-control-device/save-effective-personnel',
 				type: 'post',
 				dataType: 'json',
 				data: {"ids":ids,"accId":accId},
 				timeout: 10000,
 				success: function(json){
 					loaded();
 					if(json.success){
 						alert(json.msg);
 						$('#selection_personnel_modal').modal('toggle');
 					}else{
 						alert(json.msg);
 					}
 	            },  
 				error: function(){
 					alert('请求超时或系统出错!');
 				}
 			});
    		 
    	 }else{
    		 alert("请选择有效入场人员！")
    	 }
    	 
     }
     
     /* 获取已选中人员 */
     function getPersonnels() {
     	// 得到页面中所有input
     		var allInputs = document.getElementsByTagName('input');
     		var Ids = [];
     		// 在所有Input中过滤出type="hidden" and name="personnel_id"的元素，放到数组libIds中
     		for (var i = 0; i < allInputs.length; i++) {
     			if (allInputs[i].type === 'hidden' && allInputs[i].name === 'personnel_id') {
     				Ids.push(allInputs[i].value);
     			}
     			
     		}
 			return Ids;
      }
     
     
   //删除已选人员
 	var doDeletePersonnel = function(personnelIds){
 				var accId= $('#selection_personnel_form').find("input[name='id']").val();//设备Id
 				loading('正在删除,请稍后...');
 				var delIds = '';
 				$.each(personnelIds,function(i,personnelId){
 					delIds += ','+personnelId;
 				});
 				delIds = delIds.substring(1);
 				$.ajax({
 					url:CTX+'acc-control-device/delete-acc-control-device-personnel',
 					type:'POST',
 					data:{ids:delIds,accId:accId},
 					dataType:'json',
 					success : function(json) {  
 						//alert(json.msg);
 					},
 					error:function(){
 						alert('请求超时或系统出错!');
 					}
 				});
 				
 		 } 
	
/*]]>*/
</script>
</html>
