<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<!--
* @Copyright(c): 厦门路桥信息股份有限公司  版权所有
* @author :XMRBI
* @Description:经营快报填报
* @createDate:2018-7-18
-->
<head>
	<meta charset="UTF-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
	<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport"/>
	<title th:if="${#strings.isEmpty(readonly)}" th:text="${'经营快报填报'}"></title>
	<title th:if="${!#strings.isEmpty(readonly)}" th:text="${'经营快报查看'}"></title>
	<link rel="stylesheet" th:href="@{/static/bootstrap/css/bootstrap.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/dist/css/font-awesome.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/dist/css/ionicons.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/css/common.css}"/>
    <link rel="stylesheet" th:href="@{/static/plugins/select2/select2.css}"/>
    <link rel="stylesheet" th:href="@{/static/plugins/bootstrap-treeview/bootstrap-treeview.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/plugins/bootstrap-toggle/bootstrap-toggle.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/plugins/bootstrap-validator/css/bootstrapValidator.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/dist/css/AdminLTE.css}"/>
    <link rel="stylesheet" th:href="@{/static/dist/css/skins/_all-skins.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/dist/css/font-awesome.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/dist/css/ionicons.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/plugins/jvectormap/jquery-jvectormap-1.2.2.css}"/>
    <!-- Theme style -->
	<link rel="stylesheet" th:href="@{/static/dist/css/AdminLTE.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/dist/css/skins/_all-skins.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/css/common.css}"/>
	<!-- Bootstrap 3.3.7 -->
	<link rel="stylesheet" th:href="@{/static/bootstrap/css/bootstrap.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/plugins/bootstrap-table/dist/bootstrap-table.min.css}"/>
	<link th:href="@{/static/plugins/bootstrap-fileinput/css/fileinput.css}" media="all" rel="stylesheet" type="text/css"/>
	<link th:href="@{/static/plugins/bootstrap-fileinput/themes/explorer-fa/theme.css}" media="all" rel="stylesheet" type="text/css"/>
	<style type="text/css">
	.panel {
	  margin-bottom: 0px;
	}
	.form-group {
	  margin-bottom: 2px;
	}
	
	</style>
	<style type="text/css">
        html, body {
            overflow-x: hidden;
        }

        body {
            padding-top: 5px;
        }
        
        .box.box-solid.box-default>.box-header {
        	background-color: #DEF2FF;
        }
        
        .col-sm-10 span {
            word-break: break-all;
            word-wrap: break-word;
            white-space: normal;
            display: block;
            float: left;
            height: 34px;
            padding: 6px 12px 6px 0px;
            font-size: 14px;
            line-height: 1.42857143;
            color: #777;
        }
        
		#compList>thead>tr>th{text-align: center;vertical-align: middle !important;}
		#compList>tbody>tr>td{vertical-align: middle !important;}
		
		#annexList>thead>tr>th{text-align: center;vertical-align: middle !important;vertical-align: middle !important;}
		#annexList>tbody>tr>td{text-align: center;vertical-align: middle !important;vertical-align: middle !important;}
		
		#btn_upload,#btn_delete{
			padding: 3px 6px;
			font-size: 12px;
		}
		
		input{
			text-align: center;
		}
		
		.table>tbody>tr>td{
			padding: 3px;
		}
          
    </style>
</head>
<body>
<div class="container-fluid" style="width:100%; height: 100%" >
	<input id="CTX" th:value="${CTX}" hidden="hidden" />
	<input id="readonly" th:value="${readonly}" hidden="hidden" />
	<input id="autoClose" th:value="${autoClose}" hidden="hidden" />
	<input id="fillUseunit" th:value="${fillUseunit}" hidden="hidden" />
	<input id="opt" th:value="${'edit'}" hidden="hidden" />
	<input id="year" th:value="${year}" hidden="hidden" />
	
	<input type="hidden" id="now_user_lesseeId" name="lesseeId" th:value="${now_user_lesseeId}"/>
    <input type="hidden" id="now_user_useunitId" name="useunitId" th:value="${now_user_useunitId}"/>
    <input type="hidden" id="now_user_id" name="userId" th:value="${now_user_id}"/>
    
    <!--用户表格过滤条件 -->
    <form id="sysuserOrgFormSearch" type="hidden" class="form-horizontal">
    	<input type="hidden" name="sysuserId" th:value="${now_user_id}"/>
        <input type="hidden" id="edit_sysuser_useunit" name="useunitId"/>
    </form>
	<div class="row">
		<div class="col-md-12">
			<ul id="myTab" class="nav nav-tabs">
				<li class="active">
					<a href="#basicInfo" data-toggle="tab">基本信息</a>
				</li>
				<li>
					<a href="#annexs" data-toggle="tab"><span style="color:red;">*</span>附件</a>
				</li>
			</ul>
		</div>
	</div>
	
	<div id="myTabContent" class="tab-content">
		<div class="tab-pane fade in active" id="basicInfo">
			<div th:if="${#strings.isEmpty(readonly)}" class="box box-default collapsed-box box-solid" style="margin: 5px 0px;border-color: #DEF2FF;">
                <div class="box-header with-border" style="padding: 3px 8px;">
                    <a class='btn btn-sm btn-link' id="btn_transmit" onclick="goTransmit();">
                    	<span class="glyphicon glyphicon-transfer" aria-hidden="true" ></span>转发
                    </a>
                    <a class='btn btn-sm btn-link' id="btn_download" onclick="exportTemplet();">
                    	<span class="glyphicon glyphicon-download" aria-hidden="true"></span>下载导入模板
                    </a>
                    <a class='btn btn-sm btn-link' id="btn_upload" onclick="importExcel();">
                    	<span class="glyphicon glyphicon-upload" aria-hidden="true" ></span>导入Excel
                    </a>
                </div>
            </div>
            
			<h3 align="center" th:text="${report.reportTitle}" style="margin: 10px 0px;"></h3>
		    <form id="myform_report" class="form-horizontal">
		    	<input hidden="hidden" id="reportId"  name="id" th:value="${report.id}" />
		    	<input hidden="hidden" name="annexIds" th:value="${report.annexIds}" />
			</form>
		    
		    <div align="center">
			    <table id="compList"  th:if="${!#strings.contains(fillUseunit,'财务部')}" class="table table-bordered" style="width: 1200px;">
				   	<thead>
				   		<tr align="center">
				   			<th>经营指标</th>
				   			<th>单位</th>
				   			<th th:text="${year-1} + ${'年同期累计'}"></th>
				   			<th th:text="${year} + ${'年计划'}"></th>
				   			<th>本月发生</th>
				   			<th>本月止年累</th>
				   			<th>计划完成率</th>
				   		</tr>
				   	</thead>
				   	<tbody id="compList_body">
				   	</tbody>
				 </table>
				 
				 <table id="compList"  th:if="${#strings.contains(fillUseunit,'财务部')}" class="table table-bordered" style="width: 1200px;">
				   	<thead>
				   		<tr align="center">
				   			<th>经营指标</th>
				   			<th>单位</th>
				   			<th>期初余额</th>
				   			<th>本期收入</th>
				   			<th>本期支付</th>
				   			<th>期末余额</th>
				   		</tr>
				   	</thead>
				   	<tbody id="compList_body">
				   	</tbody>
				 </table>
			 </div>
			   
			 <div style="text-align: center;margin-bottom: 10px;">
				 <button type="button" th:if="${#strings.isEmpty(readonly)}" onclick="fnSubmitReport(false)" class="btn btn-primary" style="margin-right: 25px;width: 80px;">保存</button>
				 <button type="button" th:if="${#strings.isEmpty(readonly)}" onclick="fnSubmitReport(true)" class="btn btn-primary" style="margin-right: 25px;width: 80px;">提交</button> 
				 <button type="button" onclick="fnCloseWin(true,false)" class="btn btn-primary" style="width: 80px;">关闭</button> 
			</div>
		</div>
		
		<div class="tab-pane fade" id="annexs">
			<div class="box box-default collapsed-box box-solid" style="margin: 5px 0px;border-color: #DEF2FF;">
                <div class="box-header with-border" style="padding: 8px;">
                    <span style="font-weight: bold;font-size: 14px;">附件列表</span>
                    <form id="formAnnex" class="form-horizontal">

                    </form>
                </div>
            </div>
            
            <div align="center">
            	<div id="btn_div" class="" th:if="${#strings.isEmpty(readonly)}" style="margin-bottom: 5px;width: 1200px;" align="left">
				     <button id="btn_upload" type="button" class="btn btn-primary" th:onclick="'fnUploadAnnex('+${anndexFolder.id}+',\''+${anndexFolder.folderName}+'\')'">
				        <span class="glyphicon glyphicon-upload" aria-hidden="true" style="color: #18A689"></span>上传附件
				     </button>
				     &nbsp;
				     <button id="btn_delete" type="button" class="btn btn-primary" onclick="fnDeleteAllAnnex()" >
				        <span class="glyphicon glyphicon-remove" aria-hidden="true" style="color: red;"></span>批量删除
				     </button>
				</div>
            </div>
			
			<div align="center">
				<table id="annexList" class="table table-bordered" style="width: 1200px;">
				   	<thead>
				   		<tr align="center">
				   			<th>序号</th>
				   			<th>附件名称</th>
				   			<th>创建人</th>
				   			<th>创建时间</th>
				   			<th>操作</th>
				   		</tr>
				   	</thead>
				   	<tbody id="annexList_body">
				   		<tr th:if="${#lists.isEmpty(annexs)}" height="32px;">
							<td colspan="5" align="center">无</td>
						</tr>
						<tr th:each="annex,annexStat : ${annexs}">
							<td align="center">
								<input hidden="hidden" name="fieldIds" th:value="${annex.id}"/>
								<span th:text="${annexStat.index+1}"></span>
							</td>
							<td align="center">
								<a href="javascript:" th:onclick="'openCommonViewImgWin(\''+${annex.id}+'\')'" th:text="${annex.name}+${'.'}+${annex.extendName}"></a>
							</td>
							<td th:text="${annex.creator}" align="center"></td>
							<td th:text="${annex.uploadTime}?${#dates.format(annex.uploadTime, 'yyyy-MM-dd')}:''" align="center"></td>
							<td align="center">
								<a href="javascript:" th:onclick="'fnDeleteAnnex(this,\''+${annex.id}+'\')'" th:if="${#strings.isEmpty(readonly)}">
									<span class="glyphicon glyphicon-remove" aria-hidden="true" style="color: red;" title="删除"></span>
								</a>
							</td>
						</tr>
				   	</tbody>
				 </table>
			</div>
			
		</div>
	</div>
	
	<!-- 上传附件窗口 -->
	<div class="modal fade modal-info" id="upload_annex_win" role="dialog" data-backdrop="false" aria-hidden="true">
		<div class="modal-dialog" style="width:900px;">
	      	<div class="modal-content" style="background-color:rgba(255, 255, 255, 0);">
		        <div class="modal-header" style="padding:5px;">
		          	<button type="button" class="close" data-dismiss="modal" aria-label="Close" style="margin-top:0;">
		            	<span aria-hidden="true">&times;</span>
		            </button>
		            <button type="button" class="close" style="margin-right:5px;margin-top: -1px;" onclick="fnMaxModalWin2(this)">
		            	<i class="fa fa-square-o" style="font-size:16px;"></i>
		            </button>
		          	<h4 class="modal-title" style="text-align:center;"></h4>
		        </div>
		        <div class="modal-body" style="height: 450px;padding:0px;background-color: rgba(3, 51, 101, 0.9) !important;">
		          	<iframe id="annexFrame" name="annexFrame" style="width: 100%;height:100%;border:0;"></iframe>
		        </div>
	      	</div>
		</div>
	</div>
	
	<!-- 通用查看图片窗口 -->
	<div class="modal fade" id="common_viewimg_win" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static" aria-hidden="true">
		<div class="modal-dialog" style="width:800px;">
			<div class="modal-content">
				<div class="modal-header" style="padding:10px;">
				 	<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
					<h4 class="modal-title">图片查看</h4>
				</div>
				<div class="modal-body" style="overflow: hidden; padding: 10px;">
					
				</div>
			</div>
		</div>
	</div>
</div>

<!-- 导入文件窗口 -->
	<div class="modal fade" id="importModal" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static" aria-hidden="true">
		<div class="modal-dialog" role="document" >
			<div class="modal-content">
				<div class="modal-header">
				 	<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
					<h4 id="modal_title" class="modal-title" style="text-align: center;color: blue;">导入Excel</h4>
				</div>
				<div class="modal-body" style="overflow: hidden; padding: 10px;">
				<form style="margin-top:10px;">
					<div class="form-group">
			            <div  id="div_file"><!-- class="file-loading"  -->
			                <input id="excelFile" type="file" multiple="multiple"/>
			            </div>
			        </div>
				</form>
				<p style="font-size:12px;">说明：请下载导入模板后填写，并上传!</p>
				</div>
				<div class="modal-footer" style="text-align: center;">
					 <button type="button" class="btn btn-default" data-dismiss="modal" style="width:80px;">取消</button> 
				</div>
			</div>
		</div>
	</div>

<!-- 转发快报-->	
<div class="modal fade" id="transmit_modalwin" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static"
     aria-hidden="true">
    <div class="modal-dialog" style="width:1000px;">
        <div class="modal-content">
            <div class="modal-header" style="text-align: center;background-color: #357ca5;">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title" style="color:white;">转发——选择处理人</h4>
            </div>
            <div class="modal-body" style="padding: 10px;">
                <form class="form-horizontal" id="transmit_form">
                    <input type="hidden" name="operaterId" id="operaterId"/>
                    <input type="hidden" name="reportId" th:value="${report.id}"/>
                    <div class="box box-default box-solid" style="margin-bottom:5px; min-height: 40px">
                        <div class="box-body" id="sysuser_user_name"></div>
                    </div>
                    <div class="box box-default box-solid" style="margin-bottom:5px;">
                        <div class="box-body">
                            <div class="col-sm-6" id="orgtree_div" style="overflow: auto;">
                                <div id="edit_sysuser_orgtree"></div>
                            </div>
                            <div class="col-sm-6">
                                <table id="edit_sysuser_orgusertable"></table>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="text-align: center;">
                <button type="button" onclick="transmitReport();" class="btn btn-primary">转发</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
            </div>
        </div>
    </div>
</div>

</body>
<!-- jQuery 2.2.3 -->
<script th:src="@{/static/plugins/jQuery/jquery-2.2.3.min.js}"></script>
<!-- Bootstrap 3.3.7 -->
<script th:src="@{/static/bootstrap/js/bootstrap.min.js}"></script>
<script th:src="@{/static/js/common.js}"></script>
<script th:src="@{/static/plugins/bootstrap-validator/js/bootstrapValidator.min.js}"></script>
<script th:src="@{/static/plugins/bootstrap-table/dist/bootstrap-table.min.js}"></script>
<script th:src="@{/static/plugins/bootstrap-table/dist/locale/bootstrap-table-zh-CN.min.js}"></script>
<script th:src="@{/static/plugins/jQuery/jquery.serializejson.min.js}"></script>
<script th:src="@{/static/plugins/datepicker/bootstrap-datepicker.js}"></script>
<script th:src="@{/static/plugins/datepicker/locales/bootstrap-datepicker.zh-CN.js}"></script>
<script type="text/javascript" th:src="@{/static/plugins/bootstrap-toggle/bootstrap-toggle.min.js}"></script>
<script th:src="@{/static/plugins/bootstrap-table/dist/extensions/export/bootstrap-table-export.min.js}"></script>
<script type="text/javascript" th:src="@{/static/plugins/bootstrap-treeview/bootstrap-treeview.min.js}"></script>
<script type="text/javascript" th:src="@{/static/plugins/bootstrap-contextmenu/bootstrap-contextmenu.js}"></script>
<script type="text/javascript" th:src="@{/static/plugins/bootstrap-contextmenu/prettify.js}"></script>
<script type="text/javascript" th:src="@{/static/plugins/attention/zDialog/zDrag.js}"></script>
<!-- Slimscroll -->
<script type="text/javascript" th:src="@{/static/plugins/slimScroll/jquery.slimscroll.min.js}"></script>
<script type="text/javascript" th:src="@{/static/dist/js/app.min.js}"></script>
<script type="text/javascript" th:src="@{/static/js/common.js}"></script>
<script type="text/javascript" th:src="@{/static/js/myModalDialogBR.js}"></script>
<!-- bootstrap fileinput js -->
<script th:src="@{/static/plugins/bootstrap-fileinput/js/plugins/sortable.min.js}" type="text/javascript"></script>
<script th:src="@{/static/plugins/bootstrap-fileinput/js/plugins/purify.min.js}" type="text/javascript"></script>
<script th:src="@{/static/plugins/bootstrap-fileinput/js/fileinput.min.js}" type="text/javascript"></script>
<script th:src="@{/static/plugins/bootstrap-fileinput/js/locales/fr.js}" type="text/javascript"></script>
<script th:src="@{/static/plugins/bootstrap-fileinput/js/locales/zh.js}" type="text/javascript"></script>
<script th:src="@{/static/plugins/bootstrap-fileinput/themes/explorer-fa/theme.js}" type="text/javascript"></script>
<script th:src="@{/static/plugins/bootstrap-fileinput/themes/fa/theme.js}" type="text/javascript"></script>
<script th:inline="javascript" type="text/javascript">
/*<![CDATA[*/
	//var CTX = [[@{/}]];
	var STATIC = [[@{/static/}]];
	var CTX = $("#CTX").val() + "/";
	
	$(function () {
	    //初始化Button的点击事件
	    var oButtonInit = new ButtonInit();
	    oButtonInit.Init();
	    
	    $('.datepicker').datepicker({
	    	format:'yyyy-mm-dd',
	    	language:'zh-CN',
	      	autoclose: true
	    });
	    //加载指标完成情况
	    loadCompletion();
	    
	    initFileInput();
	    
	    //初始化转发选择用户模态窗口关闭事件
	    $('#transmit_modalwin').on('hidden.bs.modal', function (e) {
	        //resetSysuserForm();
	    });
	    
	    $('#orgtree_div').height($(window).height()-290);
	    
	});
	
	//初始化按钮
	var ButtonInit = function () {
	    var oInit = new Object();
	    var postdata = {};

	    oInit.Init = function () {
	        //初始化页面上面的按钮事件
	    };

	    return oInit;
	};
	
	//初始化导入
	function initFileInput() {
		var reportId = $('#reportId').val();
		$("#excelFile").fileinput({
	    	language:'zh',
	        uploadUrl: CTX+"business-report/import-excel",
	        uploadExtraData:{reportId:reportId},//附加参数
	        overwriteInitial: false,
	        showPreview:false,
	        showRemove:true,
	        showUpload:true,
	        allowedFileExtensions: ['xls','xlsx'],
	        maxFileSize: 100*1024,
	        maxFileCount:6,
	        enctype: 'multipart/form-data',
	        validateInitialCount: true,
	        msgFilesTooMany: "选择上传的文件数量({n}) 超过允许的最大数值{m}！"
	    }).on("fileuploaded", function (event, data) {
	    	if(data.response.success){
	    		alert("导入成功!");
	    		loadCompletion();
	    		$("#importModal").modal('hide');
	    	}else{
	    		alert(data.response.msg);
	    		$("#div_file").empty();
	    	    var element='<input id="excelFile" type="file" multiple="multiple"/>';
	    	    $("#div_file").append(element);
	    	    initFileInput();
	    	}
		});
	}
	
	//下载导入的模板
	function exportTemplet(){
		location.replace(CTX+"business-report/export-templet?"+$('#myform_report').serialize());
	}
	
	//转发快报
	function goTransmit(){
		var sysuserId = $('#now_user_id').val();
	    var lesseeId = $('#now_user_lesseeId').val();
	    $("#transmit_modalwin").modal("toggle");
	  	//初始化组织结构树
	    var r = Math.random().toString().substring(5);
	    $.ajax({
	        url: CTX + 'organizationManage/query-user-sub-org-tree?Mathnum=' + r,
	        method: 'GET',
	        dataType: 'json',
	        data: {sysuserId: sysuserId,isRoot: true},
	        success: function (json) {
	            $('#edit_sysuser_orgtree').treeview({
	                showTags: true,
	                data: json,
	                onNodeSelected: function (event, node) {
	                    $('#edit_sysuser_useunit').val(node.id);
	                    $("#edit_sysuser_orgusertable").bootstrapTable('refresh');
	                }
	            });
				
	        },
	        error: function () {
	            loaded();
	            alert('请求超时或系统出错');
	        }
	    });
	    
	    setTimeout(function(){
	    	$('#edit_sysuser_orgtree').treeview('selectNode', [ 0, { silent: true } ]);
        	var firstNode = $('#edit_sysuser_orgtree').treeview('getNode', 0);
			$('#edit_sysuser_useunit').val(firstNode.id);
			
			//初始化用户表格
	        var orgTableInit = new SysuserOrgTableInit();
	        orgTableInit.Init();
    	},500);
		
        loaded();
	}
	
	var SysuserOrgTableInit = function () {
	    var oTableInit = new Object();
	  	//初始化Table
	    oTableInit.Init = function () {
	        $('#edit_sysuser_orgusertable').bootstrapTable({
	            url: CTX + 'organizationManage/query-sub-sysuser',         //请求后台的URL（*）
	            method: 'get',                      //请求方式（*）
	            // toolbar: '#toolbar',                //工具按钮用哪个容器
	            //toolbarAlign:'left',				//工具栏位置
	            striped: true,                      //是否显示行间隔色
	            cache: false,                       //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
	            pagination: true,                   //是否显示分页（*）
	            sortable: true,                     //是否启用排序
	            sortOrder: "asc",                   //排序方式
	            queryParams: oTableInit.queryParams,//传递参数（*）
	            sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
	            pageNumber: 1,                       //初始化加载第一页，默认第一页
	            pageSize: 10,                       //每页的记录行数（*）
	            pageList: [10, 25, 50, 100],        //可供选择的每页的行数（*）
	            queryParamsType: "a",
	            search: true,                       //是否显示表格搜索
	            strictSearch: true,
	            showColumns: false,                  //是否显示所有的列
	            showRefresh: true,                  //是否显示刷新按钮
	            minimumCountColumns: 2,             //最少允许的列数
	            clickToSelect: true,                //是否启用点击选中行
	            singleSelect : true,
	            height: $(window).height()-320,                        //行高，如果没有设置height属性，表格自动根据记录条数觉得表格高度
	            uniqueId: "id",                     //每一行的唯一标识，一般为主键列
	            columns: [
	                 {
	                    field: 'name',
	                    title: '姓名',
	                    sortable: false
	                },
	                {
	                    checkbox: true
	                }
	            ],
	            onCheck:function(row){
	            	//从展示框中移除
	        	    $('#selected_edit_sysuser').remove();
	            	addSysuserShow(row.id, row.name);
	            },
	            onUncheck:function(row){
	            	//从展示框中移除
	        	    $('#selected_edit_sysuser').remove();
	        	    $('#operaterId').val('');
	            }
	        });
	        $('#edit_sysuser_orgusertable .search input').attr('placeholder', '姓名');
	    };
	    
	  	//得到查询的参数
	    oTableInit.queryParams = function (params) {
	        var data = JSON.stringify($('#sysuserOrgFormSearch').serializeJSON());
	        var temp = {   //这里的键的名字和控制器的变量名必须一致，这边改动，控制器也需要改成一样的
	            pageNum: params.pageNumber,//页码params.offset
	            size: params.pageSize,//页面大小params.limit
	            order: params.sortOrder,//排序 params.order
	            ordername: params.sortName,//排序字段 params.sort
	            from: data,
	            search: params.searchText
	        };
	        return temp;
	    };
	    return oTableInit;
	
	}
	
	function addSysuserShow(id, name) {
		$('#operaterId').val(id);
	    var htmlStr = '';
	    htmlStr +=
	        '<div id="selected_edit_sysuser" class="allRoleSysuser" style="background-color:#3daae8;color:white;width:auto;hight:60px;float:left;margin:5px;">' +
	        '	<input type="hidden" name="sysuserid" class="sysuserid" value="' + id + '"/>' +
	        '   <spand style="padding-left: 5px;padding-right: 5px;">' + name + '</spand>' +
	        '   <input type="button" class="closeDiv" onclick="removeSysuser(\'' + id + '\', \'' + name + '\')" value="X" style="background:transparent;border:none;"/>' +
	        '</div>';
	    $("#sysuser_user_name").append(htmlStr);
	}
	
	function removeSysuser(id, name) {
	    //修改表格的复选框状态
	    var index = -1;
	    $('#edit_sysuser_orgusertable tr').each(function(){
	        if($(this).attr('data-uniqueid')==id){
	            index = $(this).attr('data-index');
	        }
	    });
	    if(index!=-1){
	        $('#edit_sysuser_orgusertable').bootstrapTable('uncheck',index);//根据下标index，修改选中状态
	    }else{
	        //从展示框中移除
	        $('#selected_edit_sysuser').remove();
	        $('#operaterId').val('');
	    }
	}
	
	//转发
	function transmitReport(){
		var operaterId = $('#operaterId').val();
		if(operaterId == null || operaterId == ''){
			alert("请选择处理人！");
			return;
		}
		loading('正在处理,请稍候...');
		$.ajax({  
			url: CTX+'business-report/transmit-report',//转发
            type: 'POST',  
            data:$('#transmit_form').serialize(),// 序列化表单值  
            dataType: 'json',//服务端接收的数据类型
            async: false,
            success:function(json) {  
				if(json.success){
	            	loaded();
	            	alert('转发成功！');
	            	fnCloseWin(true,true);
				}
            },  
            error:function(json) {  
            	alert('请求超时或系统出错!');
				loaded();
            }  
        });
	}
	
	//上传附件
	function fnUploadAnnex(folderId,folderName){
		//调用统一附件管理页面
		openUploadAnnexWin({
			folderId:folderId,
			folderName:folderName/* ,
			annexIds:annexIdStr */
		},function(data){
			//附件管理回调
			if(data.length>0){
				var tbody = document.getElementById("annexList_body");
				var allRows = tbody.getElementsByTagName('tr');
				
				if(allRows != null && allRows.length > 0){
					var tds = allRows[0].getElementsByTagName('td');
					if(tds.length == 1){//原本无附件
						var children = tbody.childNodes;
						for(var i = children.length -1; i >= 0; i--){
							tbody.removeChild(children[i]);
						}
					}
				}
				
				var index = allRows == null ? 1 : allRows.length + 1;
				$.each(data,function(i,annex){
					addAnnexRow(index,annex);
					index++;
				});
			}
			//单独保存附件字段
			fnSaveReportAnnexes();
		});
	}
	
	//附件上传成功，表格添加行数据
	function addAnnexRow(index,annex){
		var tBody = document.getElementById("annexList_body");
		var allRows = tBody.getElementsByTagName('tr');
		var newRow = tBody.insertRow();
	    var newCell0 = newRow.insertCell();
	    var newCell1 = newRow.insertCell();
	    var newCell2 = newRow.insertCell();
	    var newCell3 = newRow.insertCell();
	    var newCell4 = newRow.insertCell();
	    
	    newCell0.innerHTML = "<input hidden=\"hidden\" name=\"fieldIds\" value=\"" + annex.id+ "\"/>" + "<span>"+index+"</span>";
	    newCell1.innerHTML = "<a href=\"javascript:\" onclick=\"openCommonViewImgWin(\'"+annex.id+"\')\">"+
	    	annex.name + "." + annex.extendName +"</a>";
	    newCell2.innerHTML = annex.creator;
	    newCell3.innerHTML = formatDate(annex.uploadTime);
	    newCell4.innerHTML = "<a href=\"javascript:\" onclick=\"fnDeleteAnnex(this,\'"+ annex.id +"\')\">"
	    				+ "<span class=\"glyphicon glyphicon-remove\" aria-hidden=\"true\" style=\"color: red;\" title=\"删除\"></span>"
	    				+ "</a>";
		
	}
	
	//弹出导入框
	function importExcel(){
		$("#div_file").empty();
	    var element='<input id="excelFile" type="file" multiple="multiple"/>';
	    $("#div_file").append(element);
	    initFileInput();
		$('#importModal').modal('toggle');
	}
	
	//格式化日期
	function formatDate(time){
	    var date = new Date(time);

	    var year = date.getFullYear(),
	        month = date.getMonth()+1,//月份是从0开始的
	        day = date.getDate(),
	        hour = date.getHours(),
	        min = date.getMinutes(),
	        sec = date.getSeconds();
	    var preArr = Array.apply(null,Array(10)).map(function(elem, index) {
	        return '0'+index;
	    });////开个长度为10的数组 格式为 00 01 02 03

	    var newTime = year + '-' +
	                (preArr[month]||month) + '-' +
	                (preArr[day]||day);

	    return newTime;         
	}
	
	//加载经营指标完成情况
	function loadCompletion(){
		loading('加载中...');
		var reportId = $('#myform_report').find("input[name='id']").val();
		var r = Math.random().toString().substring(5);
        $.ajax({
            url: CTX + 'indicator-completion/query-completion-list?Mathnum=' + r,
            method: 'GET',
            dataType: 'json',
            data: {reportId:reportId,opt:'edit'},
            success: function (json) {
            	paintCompList_body(json);
            },
            error: function () {
                loaded();
                alert('请求超时或系统出错');
            }
        });
	}
	
	//获得所有附件的id
	function getAllAnnexId(){
		var annexIdStr = "";
		var fieldIds = document.getElementsByName("fieldIds");
		if(fieldIds.length>0){
			for(var i=0,len=fieldIds.length; i<len; i++){
				annexIdStr += ',' + fieldIds[i].value;
			}
			annexIdStr = annexIdStr.substring(1);
		}
		return annexIdStr;
	}
	
	//批量删除
	function fnDeleteAllAnnex(){
		var annexIdStr = getAllAnnexId();
		if(annexIdStr.length > 0){
			//发送请求
			fnSendDelAnnex(annexIdStr)
			var tbody = document.getElementById("annexList_body");
			var children = tbody.childNodes;
			for(var i = children.length -1; i >= 0; i--){
				tbody.removeChild(children[i]);
			}
		}
	}
	
	//删除附件
	function fnDeleteAnnex(obj,id){
		fnSendDelAnnex(id);
		var index = obj.parentNode.parentNode.rowIndex;
		//console.log("删除附件：" + id);
		document.getElementById("annexList").deleteRow(index);
		
		//重新排序
		var tBody = document.getElementById("annexList_body");
		var allRows = tBody.getElementsByTagName('tr');
		for(var i=0;i<allRows.length;i++){
			var firstCell = allRows[i].getElementsByTagName('td')[0];
			var span = firstCell.getElementsByTagName('span')[0];
			span.innerHTML = i+1;
		}
	}
	
	//发送删除附件的请求
	function fnSendDelAnnex(annexId){
		$.ajax({
			url: CTX+"annex/delete-annex",
			type: "POST",
			data: {key: annexId},
			dataType: 'json',
			success: function(data){
				if(data.success){
					return true;
				}
			}
		});
	}
	
	//保存经营指标完成情况
	function fnSaveIndicCompletion(formId){
		if(formId != null && formId != ''){
			var compForm = document.getElementById(formId);
			saveOneCompletion($(compForm).serialize());
			return;
		}
		var saveNext = true;
		var compForms = document.getElementsByClassName("compForm");
		var params = "";
		for(var j = 0,len = compForms.length; j < len; j++){
			var compForm = compForms[j];
		    //console.log($(compForm).serialize());
		    if(saveNext){
		    	saveOneCompletion($(compForm).serialize());
		    }else{
		    	break;
		    }
		}
		return saveNext;
	}
	
	//单独保存某一指标完成情况
	function saveOneCompletion(comp){
		$.ajax({
			url: CTX+'indicator-completion/save-indicator-completion',
			type: 'post',
			dataType: 'json',
			data: comp,
			timeout: 20000,
			async: false,
			success: function(json){
				if(json.success){
				}
			},
			error: function(){
				saveNext = false;
				console.log('保存'+comp+'时出错!');
				alert('请求超时或系统出错!');
				loaded();
			}
		});
	}
	
	//保存快报
	function fnSaveReport(flag){
		//flag:是否提交
		var msg = "保存成功！";
		var url_ = '';
		if(flag){
			url_ = CTX+'business-report/submit-business-report';//提交，修改快报完成状态
			msg = "提交成功！";
		}else{
			url_ = CTX+'business-report/save-business-report';//仅保存
		}
		$.ajax({  
			url: url_,
            type: 'POST',  
            data:$('#myform_report').serialize(),// 序列化表单值  
            dataType: 'json',//服务端接收的数据类型
            async: false,
            success:function(json) {  
				if(json.success){
	            	loaded();
	            	alert(msg);
	            	fnCloseWin(flag,true);
				}
            },  
            error:function(json) {  
            	alert('保存快报时出错!');
            	//alert('请求超时或系统出错!');
				loaded();
            }  
        });  
	}
	
	//关闭当前页面
	function closeWebPage(){
		var userAgent = navigator.userAgent;
		if (userAgent.indexOf("Firefox") != -1
				|| userAgent.indexOf("Chrome") != -1) {
			window.location.href = "about:blank";
		} else {
			window.opener = null;
			window.open("", "_self");
			window.close();
		}
	}
	
	//关闭
	function fnCloseWin(isSubmit,flag){
		var autoClose = $("#autoClose").val();
    	if(autoClose == '1' && isSubmit){
			//window.parent.closeCommonFrameWin(flag);
			myReturnValueBR(1);
    		window.close();
    	}else if(autoClose != '1' && isSubmit){
    		closeWebPage();
    	}
	}
	
	//保存附件id
	function fnSaveReportAnnexes(){
		var annexIdStr = getAllAnnexId();
    	if(annexIdStr!=null && annexIdStr != ""){
    		$("input[name='annexIds']").val(annexIdStr);
    		var reportId = $('#myform_report').find("input[name='id']").val();
    		if(reportId!=''){
    			var annexIds = $('#myform_report').find("input[name='annexIds']").val();
    			$.ajax({
    				url: CTX+'business-report/save-business-report-annexes',
    				type: 'post',
    				dataType: 'json',
    				data: {reportId:reportId,annexIds:annexIds},
    				timeout: 10000,
    				success: function(json){
    					if(json.success){}
    				},
    				error: function(){
    					alert('请求超时或系统出错!');
    				}
    			});
    		}
    	}
	}
	
  	//保存、提交
    function fnSubmitReport(isSubmit){
    	var annexIdStr = getAllAnnexId();
    	if(annexIdStr!=null && annexIdStr != ""){
    		$("input[name='annexIds']").val(annexIdStr);
        	loading('正在保存,请稍后...');
        	
        	setTimeout(function(){
        		//保存经营指标完成情况
        		var saveReport = fnSaveIndicCompletion();
        		
            	if(saveReport){
            		fnSaveReport(isSubmit);
        		}
            	if(!isSubmit){
            		loadCompletion();
            	}
        	},500);
    	}else{
    		alert("请上传相关附件！");
    	}
    }
		
	/*]]>*/
</script>
<script type="text/javascript" th:src="@{/static/modules/businessplan/businessplan-uploadfile.js}"></script>
<script type="text/javascript" th:src="@{/static/modules/businessplan/business-report-edit.js}"></script>
</html>
