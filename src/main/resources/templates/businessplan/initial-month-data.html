<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<!--
* @Copyright(c): 厦门路桥信息股份有限公司  版权所有
* @author :XMRBI
* @Description:初始数据
* @createDate:2018-8-28
-->
<head>
	<meta charset="UTF-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
	<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport"/>
	<title>初始化数据</title>
	<link rel="stylesheet" th:href="@{/static/bootstrap/css/bootstrap.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/dist/css/font-awesome.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/dist/css/ionicons.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/css/common.css}"/>
    <link rel="stylesheet" th:href="@{/static/plugins/select2/select2.css}"/>
    <link rel="stylesheet" th:href="@{/static/plugins/bootstrap-treeview/bootstrap-treeview.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/plugins/bootstrap-toggle/bootstrap-toggle.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/plugins/bootstrap-validator/css/bootstrapValidator.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/dist/css/AdminLTE.css}"/>
    <link rel="stylesheet" th:href="@{/static/dist/css/skins/_all-skins.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/dist/css/font-awesome.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/dist/css/ionicons.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/plugins/jvectormap/jquery-jvectormap-1.2.2.css}"/>
    <!-- Theme style -->
	<link rel="stylesheet" th:href="@{/static/dist/css/AdminLTE.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/dist/css/skins/_all-skins.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/css/common.css}"/>
	<!-- Bootstrap 3.3.7 -->
	<link rel="stylesheet" th:href="@{/static/bootstrap/css/bootstrap.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/plugins/bootstrap-table/dist/bootstrap-table.min.css}"/>
	<style type="text/css">
	.panel {
	  margin-bottom: 0px;
	}
	.form-group {
	  margin-bottom: 2px;
	}
	
	</style>
	<style type="text/css">
        html, body {
            overflow-x: hidden;
        }

        body {
            padding-top: 5px;
        }
        
        .box.box-solid.box-default>.box-header {
        	background-color: #DEF2FF;
        }
        
        .box.box-solid>.box-header .btn.btn-default{    
			background-color: #4A90E2;
		  	border-color: #4A90E2;
		  	color:#fff;
		}

        .col-sm-10 span {
            word-break: break-all;
            word-wrap: break-word;
            white-space: normal;
            display: block;
            float: left;
            height: 34px;
            padding: 6px 12px 6px 0px;
            font-size: 14px;
            line-height: 1.42857143;
            color: #777;
        }
        
		.search_div{
			padding: 0px;
			font-family: serif;
			/* line-height: 34px;
			margin-bottom: 0px; */
		}
		
		.list-group-item{
			padding: 5px 5px;
		}
		
		#search_div{
			padding: 0px;
		}
		
		#search_div .btn.btn-default{
			background-color: #fff;
		  	border-color: gray;
		  	color:#000;
		}
		
		.modal-header{
			background-color:#F4F6F8;
			border-top-left-radius: 5px;
			border-top-right-radius: 5px;
		}
		
		a{
			font-weight: bold;
			color: #000;
		}
		
		#compList>thead>tr>th{text-align: center;vertical-align: middle !important;padding: 5px 0px;}
		#compList>tbody>tr>td{vertical-align: middle !important;padding: 3px 0px;}
		
		input{text-align: center;}
        
    </style>
</head>
<body>
<div class="container-fluid" style="width:100%; height: 100%" >
	<input id="year" hidden="hidden" th:value="${year}" />
	<input id="month" hidden="hidden" th:value="${month}" />
	
    <h3 align="center" th:text="${year} + ${'年'} + ${month} + ${'月指标完成情况'}" style="margin: 10px 0px;"></h3>
    
    <table id="compList" class="table table-bordered" style="width: 100%">
    	<thead>
    		<tr>
    			<th>经营指标</th>
    			<th>单位</th>
    			<th>本月发生</th>
    			<th>本月止年累</th>
    		</tr>
    	</thead>
    	<tbody id="compList_body">
    	</tbody>
    </table>

	<div style="text-align: center;margin-bottom: 10px;">
		<button type="button" onclick="fnSaveData()" class="btn btn-primary" style="margin-right: 25px;width: 80px;">保存</button>
		<button type="button" onclick="fnSaveData(true)" class="btn btn-primary" style="margin-right: 25px;">保存并关闭</button>
	</div>
</div>

</body>
<!-- jQuery 2.2.3 -->
<script th:src="@{/static/plugins/jQuery/jquery-2.2.3.min.js}"></script>
<!-- Bootstrap 3.3.7 -->
<script th:src="@{/static/bootstrap/js/bootstrap.min.js}"></script>
<script th:src="@{/static/js/common.js}"></script>
<script th:src="@{/static/plugins/bootstrap-validator/js/bootstrapValidator.min.js}"></script>
<script th:src="@{/static/plugins/bootstrap-table/dist/bootstrap-table.min.js}"></script>
<script th:src="@{/static/plugins/bootstrap-table/dist/locale/bootstrap-table-zh-CN.min.js}"></script>
<script th:src="@{/static/plugins/jQuery/jquery.serializejson.min.js}"></script>
<script th:src="@{/static/plugins/datepicker/bootstrap-datepicker.js}"></script>
<script th:src="@{/static/plugins/datepicker/locales/bootstrap-datepicker.zh-CN.js}"></script>
<script type="text/javascript" th:src="@{/static/plugins/bootstrap-toggle/bootstrap-toggle.min.js}"></script>
<script th:src="@{/static/plugins/bootstrap-table/dist/extensions/export/bootstrap-table-export.min.js}"></script>
<script type="text/javascript" th:src="@{/static/plugins/bootstrap-treeview/bootstrap-treeview.min.js}"></script>
<script type="text/javascript" th:src="@{/static/plugins/bootstrap-contextmenu/bootstrap-contextmenu.js}"></script>
<script type="text/javascript" th:src="@{/static/plugins/bootstrap-contextmenu/prettify.js}"></script>
<script type="text/javascript" th:src="@{/static/plugins/attention/zDialog/zDrag.js}"></script>
<!-- Slimscroll -->
<script type="text/javascript" th:src="@{/static/plugins/slimScroll/jquery.slimscroll.min.js}"></script>
<script type="text/javascript" th:src="@{/static/dist/js/app.min.js}"></script>
<script type="text/javascript" th:src="@{/static/js/common.js}"></script>
<script th:inline="javascript" type="text/javascript">
/*<![CDATA[*/
	var CTX = [[@{/}]];
	var num_lastYearAccumu = ""; 
	var num_thisYearPlan = ""; 
	var num_thisMonthAmount = ""; 
	var num_thisMonthAccumu = "";
	var num_completionRate = "";
	var num_initialBalance = ""; 
	var num_currentRevenue = ""; 
	var num_currentPayment = ""; 
	var num_endBalance = "";

	$(function () {
	    //初始化Button的点击事件
	    var oButtonInit = new ButtonInit();
	    oButtonInit.Init();
	    
	    //$('#table_div').height($(window).height()-85);
	  	//加载指标完成情况
	    loadCompletion();
	});
	
	//清空数据
	function cleanValue(){
		num_lastYearAccumu = ""; 
		num_thisYearPlan = ""; 
		num_thisMonthAmount = ""; 
		num_thisMonthAccumu = "";
		num_completionRate = "";
		num_initialBalance = ""; 
		num_currentRevenue = ""; 
		num_currentPayment = ""; 
		num_endBalance = "";
	}
	
	//初始化按钮
	var ButtonInit = function () {
	    var oInit = new Object();
	    var postdata = {};

	    oInit.Init = function () {
	        //初始化页面上面的按钮事件
	    };

	    return oInit;
	};
	
	//清除表格
	function cleanCompList_body(){
		var tbody = document.getElementById("compList_body");
		var children = tbody.childNodes;
		for(var i = children.length -1; i >= 0; i--){
			tbody.removeChild(children[i]);
		}
	}
	
	//加载
	function loadCompletion(){
		var year = $("#year").val();
		var month = $("#month").val();
		var r = Math.random().toString().substring(5);
        $.ajax({
            url: CTX + 'indicator-completion/query-initial-data?Mathnum=' + r,
            method: 'GET',
            dataType: 'json',
            data: {year:year,month:month},
            success: function (json) {
            	paintCompList_body(json);
            },
            error: function () {
                alert('请求超时或系统出错');
            }
        });
	}
	
	//绘制表格
	function paintCompList_body(comps){
		cleanCompList_body();
		removeCompForm();
		
		var tBody = document.getElementById("compList_body");
		
		for(var i=0,len=comps.length; i<len; i++){
			var blank = "";
			var indicNos = comps[i].indicator.indicNo.split(".");
			if(indicNos.length > 0){
				for(var j=1,noLen=indicNos.length; j<noLen; j++){
					blank += "&emsp;";
				}
			}
			
			num_lastYearAccumu = comps[i].comp.lastYearAccumu==null || comps[i].comp.lastYearAccumu=='null' ? "" : comps[i].comp.lastYearAccumu; 
			num_thisYearPlan = comps[i].comp.thisYearPlan==null || comps[i].comp.thisYearPlan=='null' ? "" : comps[i].comp.thisYearPlan; 
			num_thisMonthAmount = comps[i].comp.thisMonthAmount==null || comps[i].comp.thisMonthAmount=='null' ? "" : comps[i].comp.thisMonthAmount; 
			num_thisMonthAccumu = comps[i].comp.thisMonthAccumu==null || comps[i].comp.thisMonthAccumu=='null' ? "" : comps[i].comp.thisMonthAccumu;
			num_completionRate = comps[i].comp.completionRate==null || comps[i].comp.completionRate=='null' ? "" : comps[i].comp.completionRate;
			num_initialBalance = comps[i].comp.initialBalance==null || comps[i].comp.initialBalance=='null' ? "" : comps[i].comp.initialBalance; 
			num_currentRevenue = comps[i].comp.currentRevenue==null || comps[i].comp.currentRevenue=='null' ? "" : comps[i].comp.currentRevenue; 
			num_currentPayment = comps[i].comp.currentPayment==null || comps[i].comp.currentPayment=='null' ? "" : comps[i].comp.currentPayment; 
			num_endBalance = comps[i].comp.endBalance==null || comps[i].comp.endBalance=='null' ? "" : comps[i].comp.endBalance;
			
			//添加表单
			addCompForm(comps[i]);
			
			var newRow = tBody.insertRow();
			var newCell0 = newRow.insertCell();
			var newCell1 = newRow.insertCell();
			var newCell2 = newRow.insertCell();
			var newCell3 = newRow.insertCell();
			newCell1.align = "center";
			newCell2.align = "center";
			newCell3.align = "center";
			
			//指标名称
			newCell0.innerHTML = "<span>"+blank + comps[i].indicator.indicNo + "&nbsp;" + comps[i].indicator.indicName +"</span>";
			newCell1.innerHTML = "<span>"+ comps[i].indicator.unit +"</span>";
			
			newCell2.innerHTML = "<input class=\"form-control\" style=\"width: 120px;\" id=\"thisMonthAmount_"+ comps[i].comp.id 
			+"\" value=\""+ num_thisMonthAmount + "\" onchange=\"fnSetValue(\'"+comps[i].comp.indicator.unit+"\',this)\" />";
			
			newCell3.innerHTML = "<input class=\"form-control\" style=\"width: 120px;\" id=\"thisMonthAccumu_"+ comps[i].comp.id 
			+"\" value=\""+ num_thisMonthAccumu + "\" onchange=\"fnSetValue(\'"+comps[i].comp.indicator.unit+"\',this)\" />";
		}
		
		cleanValue();
	}
	
	//设值
	function fnSetValue(unit,obj,last_thisMonthAccumu){
		var objId = obj.id;
		var value = obj.value;
		var index = objId.substring(objId.indexOf('_')+1);
		var idStr = objId.substring(0,objId.indexOf('_'));
		$('#myform_comp_'+ index).find("input[name='"+idStr+"']").val(value);
		/* if(unit != "%"){
			if(idStr=='thisMonthAmount'){//本月发生,计算本月止年累
				value = parseFloat(value) + parseFloat(last_thisMonthAccumu);
				
				$('#thisMonthAccumu_'+index).text(value);
				$('#myform_comp_'+ index).find("input[name='thisMonthAccumu']").val(value);
			}
		} */
	}
	
	//移除表单
	function removeCompForm(){
		$(".compForm").remove();
	}
	
	//绘制表单
	function addCompForm(obj){
		var compForm = document.createElement("form");
		compForm.id = "myform_comp_" + obj.comp.id;
		compForm.className = "form-horizontal compForm";
		
		var idInput = document.createElement("input");
		idInput.setAttribute("name","id");
		idInput.setAttribute("type","hidden");
		idInput.setAttribute("value",obj.comp.id);
		compForm.appendChild(idInput);
		
		var reportMonth_Input = document.createElement("input");
		reportMonth_Input.setAttribute("name","reportMonth");
		reportMonth_Input.setAttribute("type","hidden");
		reportMonth_Input.setAttribute("value",obj.comp.reportMonth);
		compForm.appendChild(reportMonth_Input);

		var lastYearAccumu_Input = document.createElement("input");
		lastYearAccumu_Input.setAttribute("name","lastYearAccumu");
		lastYearAccumu_Input.setAttribute("type","hidden");
		lastYearAccumu_Input.setAttribute("value",num_lastYearAccumu);
		compForm.appendChild(lastYearAccumu_Input);

		var thisYearPlan_Input = document.createElement("input");
		thisYearPlan_Input.setAttribute("name","thisYearPlan");
		thisYearPlan_Input.setAttribute("type","hidden");
		thisYearPlan_Input.setAttribute("value",num_thisYearPlan);
		compForm.appendChild(thisYearPlan_Input);

		var thisMonthAmount_Input = document.createElement("input");
		thisMonthAmount_Input.setAttribute("name","thisMonthAmount");
		thisMonthAmount_Input.setAttribute("type","hidden");
		thisMonthAmount_Input.setAttribute("value",num_thisMonthAmount);
		compForm.appendChild(thisMonthAmount_Input);

		var thisMonthAccumu_Input = document.createElement("input");
		thisMonthAccumu_Input.setAttribute("name","thisMonthAccumu");
		thisMonthAccumu_Input.setAttribute("type","hidden");
		thisMonthAccumu_Input.setAttribute("value",num_thisMonthAccumu);
		compForm.appendChild(thisMonthAccumu_Input);

		var completionRate_Input = document.createElement("input");
		completionRate_Input.setAttribute("name","completionRate");
		completionRate_Input.setAttribute("type","hidden");
		completionRate_Input.setAttribute("value",num_completionRate);
		compForm.appendChild(completionRate_Input);
		
		var initialBalance_Input = document.createElement("input");
		initialBalance_Input.setAttribute("name","initialBalance");
		initialBalance_Input.setAttribute("type","hidden");
		initialBalance_Input.setAttribute("value",num_initialBalance);
		compForm.appendChild(initialBalance_Input);
		
		var currentRevenue_Input = document.createElement("input");
		currentRevenue_Input.setAttribute("name","currentRevenue");
		currentRevenue_Input.setAttribute("type","hidden");
		currentRevenue_Input.setAttribute("value",num_currentRevenue);
		compForm.appendChild(currentRevenue_Input);
		
		var currentPayment_Input = document.createElement("input");
		currentPayment_Input.setAttribute("name","currentPayment");
		currentPayment_Input.setAttribute("type","hidden");
		currentPayment_Input.setAttribute("value",num_currentPayment);
		compForm.appendChild(currentPayment_Input);

		var endBalance_Input = document.createElement("input");
		endBalance_Input.setAttribute("name","endBalance");
		endBalance_Input.setAttribute("type","hidden");
		endBalance_Input.setAttribute("value",num_endBalance);
		compForm.appendChild(endBalance_Input);
		
		var indicator_id_Input = document.createElement("input");
		indicator_id_Input.setAttribute("name","indicator.id");
		indicator_id_Input.setAttribute("type","hidden");
		indicator_id_Input.setAttribute("value",obj.comp.indicator.id);
		compForm.appendChild(indicator_id_Input);
		
		var version_Input = document.createElement("input");
		version_Input.setAttribute("name","version");
		version_Input.setAttribute("type","hidden");
		version_Input.setAttribute("value",obj.comp.version);
		compForm.appendChild(version_Input);
		
		document.body.appendChild(compForm);
	}
	
	//保存
	function fnSaveInitialData(obj,flag){
		$.ajax({
			url: CTX+'indicator-completion/save-initial-data',
			type: 'post',
			dataType: 'json',
			data: obj,
			timeout: 20000,
			async: false,
			success: function(json){
				if(json.success){
					
				}
			},
			error: function(){
				if(flag != null){
					alert('请求超时或系统出错!');
					loaded();
					return true;
				}
			}
		});
	}
	
	//保存所有
	function fnSaveData(flag){
		loading('正在保存,请稍后...');
		setTimeout(function(){
			var compForms = document.getElementsByTagName("form");
			var params = "";
			for(var j = 0,len = compForms.length; j < len; j++){
				var compForm = compForms[j];
				fnSaveInitialData($(compForm).serialize(),flag);
			}
			setTimeout(function(){
				if(flag){
					window.parent.closeCommonFrameWin(true);
				}else{
					loadCompletion();
				}
			},500);
			loaded();
		},500);
	}
		
	/*]]>*/
</script>	
</html>
