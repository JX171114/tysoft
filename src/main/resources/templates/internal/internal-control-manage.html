<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<!--
* @Copyright(c): 厦门路桥信息股份有限公司  版权所有
* @author :XMRBI
* @Description:内部控制管理
* @createDate:2018-11-09
-->
<head>
	<meta charset="UTF-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
	<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport"/>
	<title>内部控制管理</title>
	<link rel="stylesheet" th:href="@{/static/bootstrap/css/bootstrap.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/dist/css/font-awesome.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/dist/css/ionicons.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/css/common.css}"/>
    <link rel="stylesheet" th:href="@{/static/plugins/select2/select2.css}"/>
    <link rel="stylesheet" th:href="@{/static/plugins/bootstrap-treeview/bootstrap-treeview.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/plugins/bootstrap-toggle/bootstrap-toggle.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/plugins/bootstrap-validator/css/bootstrapValidator.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/dist/css/AdminLTE.css}"/>
    <link rel="stylesheet" th:href="@{/static/dist/css/skins/_all-skins.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/dist/css/font-awesome.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/dist/css/ionicons.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/plugins/jvectormap/jquery-jvectormap-1.2.2.css}"/>
    <!-- Theme style -->
	<link rel="stylesheet" th:href="@{/static/dist/css/AdminLTE.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/dist/css/skins/_all-skins.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/css/common.css}"/>
	<!-- Bootstrap 3.3.7 -->
	<link rel="stylesheet" th:href="@{/static/bootstrap/css/bootstrap.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/plugins/bootstrap-table/dist/bootstrap-table.min.css}"/>
	<style type="text/css">
	.panel {
	  margin-bottom: 0px;
	}
	.form-group {
	  margin-bottom: 2px;
	}
	
	</style>
	<style type="text/css">
        html, body {
            overflow-x: hidden;
        }
        body {
            padding-top: 5px;
        }
        .col-sm-10 span {
            word-break: break-all;
            word-wrap: break-word;
            white-space: normal;
            display: block;
            float: left;
            height: 34px;
            padding: 6px 12px 6px 0px;
            font-size: 14px;
            line-height: 1.42857143;
            color: #777;
        }
        .box.box-solid.box-default>.box-header {
        	background-color: #DEF2FF;
        	padding: 3px 10px;
        }
        .box.box-solid>.box-header .btn.btn-default{    
			background-color: #4A90E2;
		  	border-color: #4A90E2;
		  	color:#fff;
		}
        #MenuTree ul li:first-child{
            background-color:#d2d6de;
          	font-size:16px;
        }
        /* .btn{
        	font-size: 16px;
        	padding: 3px 12px;
        } */
        .btn-link:HOVER {
			text-decoration: none;
		}
		.modal-header{
			background-color:#F4F6F8;
			border-top-left-radius: 5px;
			border-top-right-radius: 5px;
		}
		.container-fluid{
			padding-right: 10px;
			padding-left: 10px;
		}
		.bootstrap-table{
			margin: 0px 8px;
		}
		#search_div{
			padding: 0px;
		}
		#search_div .btn.btn-default{
			background-color: #fff;
		  	border-color: gray;
		  	color:#000;
		}
		.list-group-item{
			padding: 5px 0px;
		}
		
		#toolbar .btn.btn-link{
			font-size: 16px;
			padding: 0px 12px; 
		}
		#menuTreePanel{
			border-radius: 5px;
		}
		.a_tableName{
        	font-weight: bold;
			text-decoration: underline;
			color: #000;
		}
          
    </style>
</head>
<body>
	<div class="container-fluid" style="width:100%; height: 100%" >
	    <!-- 左侧单位列表-->
	    <div class="col-sm-3">
	        <!-- 项目列表树-->
	         <div class="row" id="menuTreePanel" style="overflow: auto;border: 1px silver solid;">
	             <div id="MenuTree" data-toggle="context"></div>
	         </div>
	    </div>
	    
	     <!-- 右侧信息-->
	  	<div class="col-sm-9" style="padding-left: 0px;padding-right: 0px;">
	  		<div class="box box-default collapsed-box box-solid" style="margin-bottom: 5px;border-color: #DEF2FF;" >
				<div class="box-header with-border">
				<form id="searchForm" class="form-horizontal">
					<input name="query_directoryId" id="query_directoryId" type="hidden" />
			        <div id="search_div" class="col-md-12">
			        	<div class="col-md-3" style="min-width: 240px;padding: 0px;">
							<div class="form-group">
			                  	<label class="col-sm-3 control-label search_div" style="width: 80px;padding-left: 0px;padding-right: 0px;">流程名称:</label>
			                  	<div class="col-sm-9 search_div" style="width: 170px;">
		                    	 	<input type="text" class="form-control" id="query_name" name="query_name" value="" />
			                  	</div>
			                </div>
						</div>
			        	<div class="col-md-3" style="min-width: 240px;padding: 0px;">
							<div class="form-group">
			                  	<label class="col-sm-3 control-label search_div" style="width: 80px;padding-left: 0px;padding-right: 0px;">流程编号:</label>
			                  	<div class="col-sm-9 search_div" style="width: 170px;">
		                    	 	<input type="text" class="form-control" id="query_flowNum" name="query_flowNum" value="" />
			                  	</div>
			                </div>
						</div>
						<div class="col-md-3" style="min-width: 240px;padding: 0px;">
							<div class="form-group">
			                  	<label class="col-sm-3 control-label search_div" style="width: 80px;padding-left: 0px;padding-right: 0px;">控制方式:</label>
			                  	<div class="col-sm-9 search_div" style="width: 170px;">
		                    	 	<select class="form-control" name="query_controlWay" id="query_controlWay" style="padding-left: 3px;padding-right: 3px;">
			                    	 	<option value="">==请选择==</option>
			                    	 	<option th:each="controlWay : ${controlWayList}" th:value="${controlWay}" th:text="${controlWay}"></option>
			                    	</select>
			                  	</div>
			                </div>
						</div>
						<div class="col-md-3" style="min-width: 240px;padding: 0px;">
							<div class="form-group">
			                  	<label class="col-sm-3 control-label search_div" style="width: 80px;padding-left: 0px;padding-right: 0px;">主责部门:</label>
			                  	<div class="col-sm-9 search_div" style="width: 170px;">
		                    	 	<select class="form-control" name="query_responsibilityDept" id="query_responsibilityDept" style="padding-left: 3px;padding-right: 3px;">
			                    	 	<option value="">==请选择==</option>
			                    	 	<option th:each="useunit : ${useunitList}" th:value="${useunit.id}" th:text="${useunit.name}"></option>
			                    	</select>
			                  	</div>
			                </div>
						</div>
						<div class="col-md-3" style="min-width: 240px;padding: 0px;">
							<div class="form-group">
			                  	<label class="col-sm-3 control-label search_div" style="width: 80px;padding-left: 0px;padding-right: 0px;">状态:</label>
			                  	<div class="col-sm-9 search_div" style="width: 170px;">
		                    	 	<select class="form-control" name="query_status" id="query_status" >
			                    	 	<option value="">==请选择==</option>
			                    	 	<option value="1">启用</option>
			                    	 	<option value="0">停用</option>
			                    	</select>
			                  	</div>
			                </div>
						</div>
						<div class="col-md-3" style="min-width: 240px;padding: 0px;">
							<div class="form-group">
			                  	<label class="col-sm-3 control-label search_div" style="width: 80px;padding-left: 0px;padding-right: 0px;">维护责任人:</label>
			                  	<div class="col-sm-9 search_div" style="width: 170px;">
		                    	 	<input type="text" class="form-control" id="query_maintainer" name="query_maintainer" value="" />
			                  	</div>
			                </div>
						</div>
						<div class="col-md-3" style="min-width: 240px;padding: 0px;">
							<div class="form-group">
			                  	<label class="col-sm-3 control-label search_div" style="width: 80px;padding-left: 0px;padding-right: 0px;">流程负责人:</label>
			                  	<div class="col-sm-9 search_div" style="width: 170px;">
		                    	 	<input type="text" class="form-control" id="query_processLeader" name="query_processLeader" value="" />
			                  	</div>
			                </div>
						</div>
						
						<div class="col-md-4 " style="padding: 0px;">
	            			<div class="btn-group">
	            				<button id="btn_add" type="button" class="btn btn-default btn-sm" onclick="queryInfo();">
						        	<span class="glyphicon glyphicon-search" aria-hidden="true" style="color: #18A689"></span>查询
						        </button>
						        <button id="btn_edit" type="button" class="btn btn-default btn-sm" onclick="resetParams();">
						            <span class="glyphicon glyphicon-repeat" aria-hidden="true" style="color: #EC4758"></span>重置
						        </button>
	            			</div>
					    	<div class="btn-group">
					    		<button id="btn_add" type="button" class="btn btn-default btn-sm" onclick="fnExportList();">
						        	<span class="fa fa-file-excel-o" aria-hidden="true" style="color: #18A689"></span>导出
						        </button>
						        <button id="btn_edit" type="button" class="btn btn-default btn-sm" onclick="fnPrintList();">
						            <span class="glyphicon glyphicon-print" aria-hidden="true" style="color: #18A689"></span>打印
						        </button>
					    	</div>
	            		</div>
			        </div>
			    </form>
				</div>
			</div>
			
	  	 	<div th:if="${editAuth}" id="toolbar" class="btn-group" style="margin-bottom: 5px;margin-left: 15px;">
	             <button id="btn_add" type="button" class="btn btn-link" onclick="fnAdd()" style="font-size: 16px;">
	                	新建
	            </button>
	            <button id="btn_addchild" type="button" class="btn btn-link" onclick="fnEdit('edit')">
	                	编辑
	            </button>
	            <button id="btn_addchild" type="button" class="btn btn-link" onclick="fnEdit('change')">
	                	变更
	            </button>
	            <button id="btn_invalid" type="button" class="btn btn-link" onclick="setStatus(1)">
	                	<span style="color: green;">启用</span>
	            </button>
	            <button id="btn_isvalid" type="button" class="btn btn-link" onclick="setStatus(0)">
	                	<span style="color: red;">停用</span>
	            </button>
	        </div>
	        <table id="dataList"></table>
	    </div>
	</div>

</body>
<!-- jQuery 2.2.3 -->
<script th:src="@{/static/plugins/jQuery/jquery-2.2.3.min.js}"></script>
<!-- Bootstrap 3.3.7 -->
<script th:src="@{/static/bootstrap/js/bootstrap.min.js}"></script>
<script th:src="@{/static/js/common.js}"></script>
<script th:src="@{/static/plugins/bootstrap-validator/js/bootstrapValidator.min.js}"></script>
<script th:src="@{/static/plugins/bootstrap-table/dist/bootstrap-table.min.js}"></script>
<script th:src="@{/static/plugins/bootstrap-table/dist/locale/bootstrap-table-zh-CN.min.js}"></script>
<script th:src="@{/static/plugins/jQuery/jquery.serializejson.min.js}"></script>
<script th:src="@{/static/plugins/datepicker/bootstrap-datepicker.js}"></script>
<script th:src="@{/static/plugins/datepicker/locales/bootstrap-datepicker.zh-CN.js}"></script>
<script type="text/javascript" th:src="@{/static/plugins/bootstrap-toggle/bootstrap-toggle.min.js}"></script>
<script th:src="@{/static/plugins/bootstrap-table/dist/extensions/export/bootstrap-table-export.min.js}"></script>
<script type="text/javascript" th:src="@{/static/plugins/bootstrap-treeview/bootstrap-treeview.min.js}"></script>
<script type="text/javascript" th:src="@{/static/plugins/bootstrap-contextmenu/bootstrap-contextmenu.js}"></script>
<script type="text/javascript" th:src="@{/static/plugins/bootstrap-contextmenu/prettify.js}"></script>
<script type="text/javascript" th:src="@{/static/plugins/attention/zDialog/zDrag.js}"></script>
<!-- Slimscroll -->
<script type="text/javascript" th:src="@{/static/plugins/slimScroll/jquery.slimscroll.min.js}"></script>
<script type="text/javascript" th:src="@{/static/dist/js/app.min.js}"></script>
<script type="text/javascript" th:src="@{/static/js/common.js}"></script>
<script type="text/javascript" th:src="@{/static/js/myModalDialogBR.js}"></script>
<script th:inline="javascript" type="text/javascript">
/*<![CDATA[*/
	var CTX = [[@{/}]];
	
	$(function () {
		//1.初始化Table
	    var oTable = new TableInit();
	    oTable.Init();
		//2.初始化Button的点击事件
	    var oButtonInit = new ButtonInit();
	    oButtonInit.Init();
	    
	  	//初始化项目列表树
		$('#menuTreePanel').height($(window).height()-10);
	    initMenuTree();
		
	});
	
	//初始化列表
	var TableInit = function () {
	    var oTableInit = new Object();
	    //初始化Table
	    oTableInit.Init = function () {
	        $('#dataList').bootstrapTable({
	        	url: CTX + 'internal-control-flow/query-page', //请求后台的URL（*）
	            method: 'get',                      //请求方式（*）
	            striped: true,                      //是否显示行间隔色
	            cache: false,                       //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
	            pagination: true,                   //是否显示分页（*）
	            sortable: false,                     //是否启用排序
	            sortOrder: "asc",                   //排序方式
	            queryParams: oTableInit.queryParams,//传递参数（*）
	            sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
	            pageNumber:1,                       //初始化加载第一页，默认第一页
	            pageSize: 10,                       //每页的记录行数（*）
	            pageList: [10, 25, 50, 100],        //可供选择的每页的行数（*）
	            queryParamsType: "a",
	            strictSearch: true,
	            //showColumns: true,                  //是否显示所有的列
	            minimumCountColumns: 2,             //最少允许的列数
	            clickToSelect: true,                //是否启用点击选中行
	            height:$(window).height()-150,	    //行高，如果没有设置height属性，表格自动根据记录条数觉得表格高度
	            uniqueId: "id",                     //每一行的唯一标识，一般为主键列
	            //singleSelect: true,
	            undefinedText: "",
	            columns: [
				{
	            	checkbox:true
		        },{
				    field: 'number',
				    title:'序号',
				    align : 'center',
				    sortable:true,
				    formatter:function(value,row,index){
				    	var pageSize=$('#dataList').bootstrapTable('getOptions').pageSize;
		                var pageNumber=$('#dataList').bootstrapTable('getOptions').pageNumber;
		                return pageSize * (pageNumber - 1) + index + 1;
				    }
				},{
				    field: 'flowNum',
				    title:'流程编号',
				    align : 'center',
				    sortable:true
				},{
				    field: 'name',
				    title:'流程名称',
				    align : 'center',
				    sortable:true,
				    formatter:function(v,r,i){
						return '<a class="a_tableName" href="javascript:fnToView(\'' + r.id + '\')">'+ r.name +'</a>';
	   				}
				},{
				    field: 'controlWay',
				    title:'控制方式',
				    align : 'center',
				    sortable:true
				},{
				    field: 'responsibilityDept',
				    title:'主责部门',
				    align : 'center',
				    sortable:true,
				    formatter:function(useunit){
				   		return useunit.name;
				    }
				},{
				    field: 'maintainer',
				    title:'维护责任人',
				    align : 'center',
				    sortable:true,
				    formatter:function(user){
				   		return user.name;
				    }
				},{
				    field: 'processLeader',
				    title:'流程负责人',
				    align : 'center',
				    sortable:true,
				    formatter:function(user){
				   		return user.name;
				    }
				},{
				    field: 'versionNo',
				    title:'版本号',
				    align : 'center',
				    sortable:true
				},{
				    field: 'status',
				    title:'状态',
				    align : 'center',
				    sortable:true,
				    formatter:function(value){
				    	if(value == 1){
				    	    return '启用';
				    	}else if(value == 0){
				    		return '停用';
				    	}
				    }
				},],
				formatShowingRows: function (pageFrom, pageTo, totalRows) {
		            return '共 ' + totalRows + ' 条';
		        },
	        });
	    };

	    //得到查询的参数
	    oTableInit.queryParams = function (params) {
	    	var data = JSON.stringify($('#searchForm').serializeJSON());
	        var temp = {   //这里的键的名字和控制器的变量名必须一致，这边改动，控制器也需要改成一样的
	        	searchForm:data,
	        	pageNum: params.pageNumber,//页码params.offset
                size: params.pageSize//页面大小params.limit
	        };
	        return temp;
	    };
	    return oTableInit;
	};
	
	//查询-刷新
	function queryInfo(pageNo){
		if(pageNo == null){
			pageNo = $('#dataList').bootstrapTable('getOptions').pageNumber;
		}
		$('#dataList').bootstrapTable('refreshOptions',{pageNumber:pageNo,pageSize:10});
	}
	
	//初始化项目树
	function initMenuTree() {
    	var r = Math.random().toString().substring(5);
        $.ajax({
            url: CTX + 'internal-control-directory/query-tree?Mathnum=' + r,
            method: 'GET',
            dataType: 'json',
            async: false,
            data: {selectable:true},
            success: function (json) {
            	var treedata = [{
					id:0,
			    	text: "项目目录",
			    	treeCode:'0',
			    	enable: true,
			    	icon:"",
			    	selectable:false,
			    	nodeType:"typeProject",
			    	nodes:json
			  	}];
                $('#MenuTree').treeview({
                    showTags: true,
                    data:treedata,
                    //showCheckbox: true,
                    onNodeSelected: function(event, node) {
                        $("#query_directoryId").val(node.id);
                        console.log(node.id);
                        queryInfo(1);
                    }
                });
                $('#MenuTree').treeview('expandAll');
                loaded();
            },
            error: function () {
                loaded();
                alert('请求超时或系统出错');
            }
        });
        
    	var firstNode = $('#MenuTree').treeview('getNode', 1);
    	if(firstNode != null){
	        $('#MenuTree').treeview('selectNode', [ 1, { silent: true } ]);
			$('#query_directoryId').val(firstNode.id);
			queryInfo(1);
    	}
    }
	
  	//新建工作用表
    function fnAdd() {
    	var r = Math.random().toString().substring(5);
    	var directoryId = $("#query_directoryId").val();
		var url = CTX+'internal-control-flow/detail?opt=new&directoryId='+directoryId+'&Mathnum='+r;
		var name = "新增流程";
		myShowModalDialogBR(url,name,window.screen.width,window.screen.height,function(v){
 			if(v==1){
 				queryInfo();
 			}
 		});
  	}
  	
	//编辑or变更
	function fnEdit(opt){
		var seldatas = $('#dataList').bootstrapTable('getSelections');
		if(seldatas.length==0){
			alert('请选择流程！');
			return;
		}
		if(seldatas.length>1){
			alert('只会编辑所选的第一项！');
		}
		var selData = seldatas[0];
		dId = selData.id;
		
		var r = Math.random().toString().substring(5);
		var url = CTX+'internal-control-flow/detail?opt=' + opt +'&id='+dId+'&Mathnum='+r;
		var name = "变更流程";
		myShowModalDialogBR(url,name,window.screen.width,window.screen.height,function(v){
 			if(v==1){
 				queryInfo();
 			}
 		});
	}
	
	//启用or停用
	function setStatus(flag){
		var seldatas = $('#dataList').bootstrapTable('getSelections');
		if(seldatas.length==0){
			return;
		}
		loading('正在保存设置,请稍候...');
		var ids = "";
		for(var i = 0; i < seldatas.length ; i++){
			ids += "," + seldatas[i].id;
		}
		ids = ids.substring(1);
		$.ajax({
            url: CTX + 'internal-control-flow/set-status',
            method: 'post',
            dataType: 'json',
            data: {ids:ids,status:flag},
            success: function (json) {
                alert(json.msg);
                queryInfo();
                loaded();
            },
            error: function () {
                alert('请求超时或系统出错!');
            }
        });
	}
	
	//重置查询条件
	function resetParams(){
		$('#query_flowNum').val('');
		$('#query_name').val('');
		$('#query_controlWay').val('');
		$('#query_responsibilityDept').val('');
		$('#query_status').val('');
		$('#query_maintainer').val('');
		$('#query_processLeader').val('');
	}
	
	//导出列表
	function fnExportList(){
		
		location.replace(CTX+"internal-control-flow/export-list?"+$('#searchForm').serialize());
	}
	
	//打印列表
	function fnPrintList(){
		var pageNum = $('#dataList').bootstrapTable('getOptions').pageNumber;
		var size = $('#dataList').bootstrapTable('getOptions').pageSize;
		var r = Math.random().toString().substring(5);
		var url = CTX+'internal-control-flow/list-print?Mathnum='+r+'&pageNum='+pageNum+'&size='+size+'&'+$('#searchForm').serialize();
		var name = "打印内控管理流程列表";
		myShowModalDialogBR(url,name,window.screen.width,window.screen.height,function(v){
 			if(v==1){
 			}
 		});
	}
	
	//查看工作用表详情
	function fnToView(dId){
		var r = Math.random().toString().substring(5);
		var url = CTX+'internal-control-flow/view?id='+dId+'&Mathnum='+r;
		var name = "工作用表详情";
		myShowModalDialogBR(url,name,window.screen.width,window.screen.height,function(v){
 			if(v==1){
 				queryInfo();
 			}
 		});
	}
	
	//初始化按钮
	var ButtonInit = function () {
	    var oInit = new Object();
	    var postdata = {};

	    oInit.Init = function () {
	        //初始化页面上面的按钮事件
	    };

	    return oInit;
	};
		
	/*]]>*/
</script>	
</html>
