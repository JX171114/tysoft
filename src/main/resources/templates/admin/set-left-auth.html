<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
	<!-- Tell the browser to be responsive to screen width -->
	<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport"/>
	<title>左侧菜单权限编辑</title>
	<link rel="stylesheet" th:href="@{/static/bootstrap/css/bootstrap.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/dist/css/font-awesome.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/dist/css/ionicons.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/css/common.css}"/>
	<link rel="stylesheet" th:href="@{/static/plugins/select2/select2.css}"/>
	<link rel="stylesheet" th:href="@{/static/plugins/bootstrap-treeview/bootstrap-treeview.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/plugins/bootstrap-toggle/bootstrap-toggle.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/plugins/bootstrap-validator/css/bootstrapValidator.min.css}"/>
	<link rel="stylesheet" th:href="@{/static/dist/css/AdminLTE.css}" />
	<link rel="stylesheet" th:href="@{/static/dist/css/skins/_all-skins.min.css}" />
	<style type="text/css">
		html,body {overflow-x:hidden;}
		body {
			padding-top:50px;
		}
		.navbar{padding: 0 10px;}
		.bar_left {
		    float: left;
		    line-height: 49px;
		}
		.bar_right {
		    float: right;
		    line-height: 49px;
		}
		.page_title {
		    width: 50%;
		    position: absolute;
		    left: 25%;
		    font-weight: 400;
		    text-align: center;
		    color: #232528;
		    font-size: 18px;
		    overflow: hidden;
		    white-space: nowrap;
		    text-overflow: ellipsis;
		    margin-top:none;
		}
		.col-sm-10 span{    
			word-break: break-all;
		    word-wrap: break-word;
		    white-space: normal;
		    display: block;
		    float:left;
		    height: 34px;
		    padding: 6px 12px 6px 0px;
		    font-size: 14px;
		    line-height: 1.42857143;
		    color: #777;
	    }
		#menuTree{margin-top:10px;}
		
		.form-group.no-valid-btn.has-feedback.has-error .glyphicon.glyphicon-remove:before{content:''}
		.form-group.no-valid-btn.has-feedback.has-success .glyphicon.glyphicon-ok:before{content:''}
	</style>
</head>
<body>
	<nav class="navbar navbar-fixed-top navbar-default">
		<div class="bar_left"><button class="btn btn-default" type="button" onclick="fnGoBack()"><em class="glyphicon glyphicon-arrow-left"></em></button></div>
	  	<h2 class="page_title" style="margin-top:15px;" th:text="${parentAuth.name}+'-左侧菜单权限配置'"></h2>
	</nav>
	<div id="container" class="container">
		<div class="row clearfix">
			<div class="col-md-12 column">
				<input type="hidden" id="parentId" th:value="${parentAuth.id}" />
				<div id="menuTree" data-toggle="context" data-target="#context-menu"></div>
			</div>
		</div>
		
		<div id="context-menu">
		    <ul class="dropdown-menu" role="menu">
		      <li><a tabindex="-1" id="addMenu"><em id="addMenu" class="glyphicon glyphicon-plus"></em>增加子菜单</a></li>
		      <li><a tabindex="-1" id="editMenu"><em id="editMenu" class="glyphicon glyphicon-pencil"></em>修改菜单</a></li>
		      <li><a tabindex="-1" id="downMenu"><em id="downMenu" class="glyphicon glyphicon-arrow-down"></em>下移</a></li>
		      <li><a tabindex="-1" id="upMenu"><em id="upMenu" class="glyphicon glyphicon-arrow-up"></em>上移</a></li>
		      <li><a tabindex="-1" id="removeMenu"><em id="removeMenu" class="glyphicon glyphicon-remove"></em>删除</a></li>
	    	</ul>
	  	</div>
	</div>
	
	
	<!-- 编辑菜单窗体 -->
	<div class="modal fade" id="menu_modalwin" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					 <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
					<h4 class="modal-title" id="myModalLabel">新增菜单</h4>
				</div>
				<div class="modal-body">
					<form id="menuForm" role="form" class="form-horizontal">
						<input type="hidden" name="id" />
						<input type="hidden" name="authorityType" th:value="${authorityType}"/>
						<div class="form-group">
							<label class="col-sm-3 control-label">上级菜单：</label>
							<div class="col-sm-9">
							  <input type="text" class="form-control" id="parent_name" disabled="disabled"/>
							  <input type="hidden" name="parentId" />
							</div>
						</div>
						<div class="form-group">
							<label class="col-sm-3 control-label">菜单名称：</label>
							<div class="col-sm-9">
							  <input type="text" class="form-control" name="name" placeholder="10个字以内"/>
							</div>
						</div>
						<div class="form-group">
							<label class="col-sm-3 control-label">菜单图标：</label>
							<div class="col-sm-9">
								<div class="input-group">
						            <input type="text" class="form-control" name="icon" placeholder="Font Awesome或Glyphicon样式" readonly="readonly" />
						            <span class="input-group-addon" style="cursor: pointer;" onclick="doSelectIcon()"><i class="fa fa-check fa-lg" title="图标预览"></i></span>
						        </div>
							</div>
						</div>
						<div class="form-group">
							<label class="col-sm-3 control-label">URL地址：</label>
							<div class="col-sm-9">
								<div class="input-group">
					                <div class="input-group-btn">
					                  	<button id="urlHeader_btn" type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
					                  		<span id="urlHeadr_span">frame:</span>
				                    		<span class="fa fa-caret-down"></span>
				                    	</button>
					                  	<ul class="dropdown-menu">
						                    <li><a href="javascript:fnSetUrlHead('frame:')">frame:</a></li>
						                    <li><a href="javascript:fnSetUrlHead('window:')">window:</a></li>
					                  	</ul>
				                	</div>
					                <input type="hidden" name="urlHeader" value="frame:"/>
					                <input type="text" name="url" class="form-control" placeholder="请输入菜单地址"/>
				              	</div>
							</div>
						</div>
						<div class="form-group">
						 	<label for="wapp_url" class="col-sm-3 control-label">默认显示</label>
							<div class="col-sm-9">
								<select id="roleType_selmenu" name="defaultRoleTypes" multiple="multiple" class="form-control" style="width:100%;">
									<option value="sys">系统管理员</option>
									<option value="admin">企业管理员</option>
									<option value="normal">普通角色</option>
								</select>
							</div>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					 <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button> 
					 <button type="button" class="btn btn-primary" onclick="submitMenuForm(this)">保存</button>
				</div>
			</div>
		</div>
	</div>
</body>
<script type="text/javascript" th:inline="javascript">
/*<![CDATA[*/
	var CTX = [[@{/}]];
	var STATIC = [[@{/static/}]];
/*]]>*/		
</script>
<script type="text/javascript" th:src="@{/static/plugins/jQuery/jquery-2.2.3.min.js}"></script>
<script type="text/javascript" th:src="@{/static/bootstrap/js/bootstrap.min.js}"></script>
<script type="text/javascript" th:src="@{/static/plugins/select2/select2.js}"></script>
<script type="text/javascript" th:src="@{/static/plugins/bootstrap-toggle/bootstrap-toggle.min.js}"></script>
<script type="text/javascript" th:src="@{/static/plugins/bootstrap-validator/js/bootstrapValidator.min.js}"></script>
<script type="text/javascript" th:src="@{/static/js/common.js}"></script>
<script type="text/javascript" th:src="@{/static/plugins/bootstrap-treeview/bootstrap-treeview.min.js}"></script>
<script type="text/javascript" th:src="@{/static/plugins/bootstrap-contextmenu/bootstrap-contextmenu.js}"></script>
<script type="text/javascript" th:src="@{/static/plugins/bootstrap-contextmenu/prettify.js}"></script>
<script type="text/javascript" th:inline="javascript">
/*<![CDATA[*/
	$(function(){
		$("#roleType_selmenu").select2({
		    tags: true,
		    placeholder: "选择角色类型",
		    allowClear: true
		});
		//初始化菜单树
		initMenuTree();
		//初始化表单
	    $('#menuForm').bootstrapValidator({
			message: '此处输入有误',
	        excluded: [':disabled'],
	        feedbackIcons: {
	            valid: 'glyphicon glyphicon-ok',
	            invalid: 'glyphicon glyphicon-remove',
	            validating: 'glyphicon glyphicon-refresh'
	        },
	        fields:{
	        	'name':{
	        		message: '菜单名称输入不合法',
	                validators: {
	                    notEmpty: {
	                        message: '菜单名称不可为空'
	                    },
	                    stringLength: {
	                        max: 10,
	                        message: '长度必须在10个字内'
	                    }
	                }
	        	},
	        	'icon':{
	        		message: '菜单图标输入不合法',
	                validators: {
	                    notEmpty: {
	                        message: '菜单图标不可为空'
	                    }
	                }
	        	}
	        }
		});
		//编辑窗口关闭事件
		$('#menu_modalwin').on('hidden.bs.modal',function(){
			fnResetMenuForm();
		});
	});
	
	function fnResetMenuForm(){
		$("input[name='id']").val('');
		$("input[name='parentId']").val('');
		$('#parent_name').val('');
		$("#roleType_selmenu").val('').trigger("change");
		$("input[name='icon']").next().find('i').attr('class','fa fa-check fa-lg');
		$("input[name='url']").val('');
		$('#urlHeadr_span').html('frame:');
		$("input[name='urlHeader']").val('frame:');
		$('#menuForm').bootstrapValidator('resetForm', true);
	}
	
	function initMenuTree(){
		loading("正在加载...");
		$.ajax({
			url:CTX+'authority/query-left-auth',
			method:'GET',
			dataType:'json',
			data:{parentId:$('#parentId').val(),authorityType:$("input[name='authorityType']").val(),mathNum:Math.random().toString().substring(5)},
			success:function(json){
				var treedata = [{
					id:$('#parentId').val(),
			    	text: "右击创建树形菜单",
			    	treeCode:'0',
			    	color:'#ccc',
			    	selectable:false,
			    	nodes:json
			  	}];
				
				$('#menuTree').treeview({
					showTags: true,
					data: treedata
				});
				$('#menuTree').treeview('expandAll');
				initTreeContextmenu();
				loaded();
			},
			error:function(){
				loaded();
				alert('请求超时或系统出错');
			}
		});
	}
	var currentNode = null;
	function initTreeContextmenu(){
		$('#menuTree').contextmenu({
			target:'#context-menu',
			before: function(e, context) {
				var nodeId = e.target.getAttribute("data-nodeid");
				var node = $('#menuTree').treeview('getNode', nodeId);
				currentNode = node;
				var treeCodeLen = currentNode.treeCode.split(',');
				$('#addMenu,#removeMenu,#editMenu,#upMenu,#downMenu').show();
				if(currentNode.treeCode=='0'){
					$('#removeMenu,#editMenu,#upMenu,#downMenu').hide();
				}else if(treeCodeLen.length>=4){
					$('#addMenu').hide();
				}
			},
			onItem: function(context, e) {
				var operId = e.target.getAttribute('id');
				if(operId=='addMenu'){
					goAddMenu();
				}
				if(operId == 'editMenu'){
					goEditMenu();
				}
				if(operId == 'removeMenu'){
					goDelMenu();
				}
				if(operId == 'upMenu' || operId == 'downMenu'){
					goUporDownMenu(operId);
				}
			}
		});
	}
	
	function goDelMenu(){
		var authId = currentNode.id;
		if(window.confirm('确定要删除该权限菜单吗？')){
			$.ajax({
				url:CTX+'authority/delete-authority',
				data:{ids:authId,mathNum:Math.random().toString().substring(5)},
				method:'POST',
				dataType:'json',
				success:function(json){
					alert(json.msg);
					if(json.success){
						initMenuTree();
					}
				},
				error: function(){
					alert('系统错误或请求超时');
				}
			});
		}
	}
	
	function goUporDownMenu(operId){
		var authId = currentNode.id;
		$.ajax({
			url:CTX+'authority/save-auth-sort',
			data:{authId:authId,operId:operId},
			method:'POST',
			dataType:'text',
			success:function(result){
				if(result=='success'){
					initMenuTree();
				}else{
					alert('保存失败');
				}
			},
			error: function(){
				alert('系统错误或请求超时');
			}
		});
	}
	
	function goAddMenu(){
		fnResetMenuForm();
		$('#menu_modalwin').modal('toggle');
		$('#myModalLabel').text('新增菜单');
		$('#menuForm').find("input[name='parentId']").val(currentNode.id);
		if(currentNode.id==$('#parentId').val())
			$('#parent_name').val('一级菜单');
		else
			$('#parent_name').val(currentNode.text);
	}
	
	function goEditMenu(){
		fnResetMenuForm();
		$('#menu_modalwin').modal('toggle');
		$('#myModalLabel').text('编辑菜单');
		var authId = currentNode.id;
		$.ajax({
			url:CTX+'authority/find-authority',
			data:{authId:authId,mathNum:Math.random().toString().substring(5)},
			method:'GET',
			dataType:'json',
			success:function(json){
				if(json){
					var auth = json.auth;
					var parent = json.parent;
					var $form = $('#menuForm');
					$form.find("input[name='id']").val(auth.id);
					$form.find("input[name='parentId']").val(auth.parentId);
					$form.find("input[name='name']").val(auth.name);
					$('#parent_name').val(parent.id==$('#parentId').val()?'一级菜单':parent.name);
					$form.find("input[name='icon']").val(auth.icon);
					$form.find("input[name='icon']").next().find('i').attr('class',auth.icon+' fa-lg');
					if(auth.defaultRoleTypes!=null&&auth.defaultRoleTypes!=''){
						$("#roleType_selmenu").val(auth.defaultRoleTypes.split(',')).trigger("change");
					}
					if(auth.url!=null){
						$form.find("input[name='url']").val(auth.url.substring(auth.url.indexOf(':')+1));
						$('#urlHeadr_span').html(auth.url.substring(0,auth.url.indexOf(':')+1));
						$form.find("input[name='urlHeader']").val(auth.url.substring(0,auth.url.indexOf(':')+1));
					}
				}
			},
			error: function(){
				alert('系统错误或请求超时');
				$('#menu_modalwin').modal('toggle');
			}
		});
	}
	
	function submitMenuForm(_this){
		var result = $('#menuForm').data('bootstrapValidator');
		result.validate();
		if(result.isValid()){
			var oldTxt = $(_this).text();
			$(_this).attr('disabled','disabled');
			$(_this).html('保存中...');
			$.ajax({  
				url: CTX+'authority/save-authority',
	            type: 'POST',  
	            data:$('#menuForm').serialize(),// 序列化表单值  
	            dataType: 'json',
	            success:function(json) {
	            	alert(json.msg);
					$(_this).removeAttr('disabled');
					$(_this).html(oldTxt);
					if(json.success){
						$('#menu_modalwin').modal('toggle');
						initMenuTree();
					}
	            },  
	            error:function(json) {  
	            	alert('请求超时或系统出错!');
	            	$(_this).removeAttr('disabled');
					$(_this).html(oldTxt);
	            }  
	        });  
		}
	}
	
	
	function fnSetUrlHead(txt){
		$('#urlHeadr_span').html(txt);
		$("input[name='urlHeader']").val(txt);
	}
	
	function doSelectIcon(){
		var width = $(window.parent).width()*3/4;//定义长度
		var height = $(window.parent).height()-50;
		var url = STATIC+"/modules/select-icon.html";
		top.openCommonFrameWin(url,width,height,function(returnData){
			if(returnData){
				$("input[name='icon']").val(returnData);
				$("input[name='icon']").next().find('i').attr('class',returnData+' fa-lg');
				var bootstrapValidator = $('#menuForm').data('bootstrapValidator');  
				bootstrapValidator.updateStatus('icon', 'NOT_VALIDATED').validateField('icon');
			}
		});
	}
	var backPage = [[${backPage}]];
	function fnGoBack(){
		window.location.href = CTX+'authority/'+backPage+'.html?authId='+$('#parentId').val();
	}
/*]]>*/		
</script>
</html>